{
  "sha": "38af28d58bd1652d524306e8fe170178115ce43e",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODozOGFmMjhkNThiZDE2NTJkNTI0MzA2ZThmZTE3MDE3ODExNWNlNDNl",
  "commit": {
    "author": {
      "name": "Bianca Nenciu",
      "email": "nbianca@users.noreply.github.com",
      "date": "2021-05-21T08:34:17Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2021-05-21T08:34:17Z"
    },
    "message": "FIX: Allow add email to group if user can invite (#13097)\n\nIt used to allow adding email addresses to a group even if invites were\r\ndisabled for the site. This does not allow user to input email address\r\nif they cannot invite.\r\n\r\nThe second thing this commit improves is the message that is displayed\r\nto the user when they hit the invite rate limit.",
    "tree": {
      "sha": "da75d26d5a2cd7bb2da83ba9cb02eefb2bb8061b",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/da75d26d5a2cd7bb2da83ba9cb02eefb2bb8061b"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/38af28d58bd1652d524306e8fe170178115ce43e",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgp3CJCRBK7hj4Ov3rIwAAvioIAFgCmsnGDwvWyNuH65SnGVpL\nRzi8iGf5R9uqC7UmsP52U4IcYT1bIUxj1iLbU5DGGnt8bNbfoOxH34PTXgV2CYQe\nDMHKLRm06zha/jt95IkR60TfHgF4nToZo2/aH7XFEStDwGAbfc84NXW9utj5mCCh\na83s3uT1aiJrCl+ViuP8XTjJGI68Ru0b03j3BjPr66YAhFnlVB6OwxmOGgNuPYBP\nskEnZT2dJCiwzIP1Tnbfa8YFZuhlLEnsteZOaumBylhWKrMeLQR+TbPxmHtiW/lw\nDnZt5niYSZgocBYxGs9sDbQXFrCmsgjD+oWwp/+r4zvukwV4de3uTV4XLlB76Cw=\n=upxF\n-----END PGP SIGNATURE-----\n",
      "payload": "tree da75d26d5a2cd7bb2da83ba9cb02eefb2bb8061b\nparent 4ce854f21ca52783625b2be82b8bc0dff3cfeebd\nauthor Bianca Nenciu <nbianca@users.noreply.github.com> 1621586057 +0300\ncommitter GitHub <noreply@github.com> 1621586057 +0300\n\nFIX: Allow add email to group if user can invite (#13097)\n\nIt used to allow adding email addresses to a group even if invites were\r\ndisabled for the site. This does not allow user to input email address\r\nif they cannot invite.\r\n\r\nThe second thing this commit improves is the message that is displayed\r\nto the user when they hit the invite rate limit."
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/38af28d58bd1652d524306e8fe170178115ce43e",
  "html_url": "https://github.com/discourse/discourse/commit/38af28d58bd1652d524306e8fe170178115ce43e",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/38af28d58bd1652d524306e8fe170178115ce43e/comments",
  "author": {
    "login": "nbianca",
    "id": 23153890,
    "node_id": "MDQ6VXNlcjIzMTUzODkw",
    "avatar_url": "https://avatars.githubusercontent.com/u/23153890?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nbianca",
    "html_url": "https://github.com/nbianca",
    "followers_url": "https://api.github.com/users/nbianca/followers",
    "following_url": "https://api.github.com/users/nbianca/following{/other_user}",
    "gists_url": "https://api.github.com/users/nbianca/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nbianca/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nbianca/subscriptions",
    "organizations_url": "https://api.github.com/users/nbianca/orgs",
    "repos_url": "https://api.github.com/users/nbianca/repos",
    "events_url": "https://api.github.com/users/nbianca/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nbianca/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4ce854f21ca52783625b2be82b8bc0dff3cfeebd",
      "url": "https://api.github.com/repos/discourse/discourse/commits/4ce854f21ca52783625b2be82b8bc0dff3cfeebd",
      "html_url": "https://github.com/discourse/discourse/commit/4ce854f21ca52783625b2be82b8bc0dff3cfeebd"
    }
  ],
  "stats": {
    "total": 37,
    "additions": 29,
    "deletions": 8
  },
  "files": [
    {
      "sha": "9a7427f87636886575cfcedb6f1c972fd488a4b9",
      "filename": "app/assets/javascripts/discourse/app/templates/modal/group-add-members.hbs",
      "status": "modified",
      "additions": 7,
      "deletions": 3,
      "changes": 10,
      "blob_url": "https://github.com/discourse/discourse/blob/38af28d58bd1652d524306e8fe170178115ce43e/app/assets/javascripts/discourse/app/templates/modal/group-add-members.hbs",
      "raw_url": "https://github.com/discourse/discourse/raw/38af28d58bd1652d524306e8fe170178115ce43e/app/assets/javascripts/discourse/app/templates/modal/group-add-members.hbs",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/discourse/app/templates/modal/group-add-members.hbs?ref=38af28d58bd1652d524306e8fe170178115ce43e",
      "patch": "@@ -2,7 +2,11 @@\n   <form class=\"form-vertical group-add-members\">\n     <div class=\"control-group\">\n       <label class=\"control-label\">\n-        {{i18n \"groups.add_members.usernames\"}}\n+        {{#if currentUser.can_invite_to_forum}}\n+          {{i18n \"groups.add_members.usernames_or_emails.title\"}}\n+        {{else}}\n+          {{i18n \"groups.add_members.usernames.title\"}}\n+        {{/if}}\n       </label>\n       <p class=\"description\">\n         {{i18n \"groups.add_members.description\"}}\n@@ -14,8 +18,8 @@\n         id=\"group-add-members-user-selector\"\n         onChange=(action (mut usernamesAndEmails))\n         options=(hash\n-          allowEmails=true\n-          filterPlaceholder=\"groups.add_members.input_placeholder\"\n+          allowEmails=currentUser.can_invite_to_forum\n+          filterPlaceholder=(if currentUser.can_invite_to_forum \"groups.add_members.usernames_or_emails.input_placeholder\" \"groups.add_members.usernames.input_placeholder\")\n         )\n       }}\n     </div>"
    },
    {
      "sha": "69dff9cf26dac3a513a68720b4adec6e950a0878",
      "filename": "app/controllers/groups_controller.rb",
      "status": "modified",
      "additions": 9,
      "deletions": 1,
      "changes": 10,
      "blob_url": "https://github.com/discourse/discourse/blob/38af28d58bd1652d524306e8fe170178115ce43e/app/controllers/groups_controller.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/38af28d58bd1652d524306e8fe170178115ce43e/app/controllers/groups_controller.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/controllers/groups_controller.rb?ref=38af28d58bd1652d524306e8fe170178115ce43e",
      "patch": "@@ -368,7 +368,15 @@ def add_members\n       end\n \n       emails.each do |email|\n-        Invite.generate(current_user, email: email, group_ids: [group.id])\n+        begin\n+          Invite.generate(current_user, email: email, group_ids: [group.id])\n+        rescue RateLimiter::LimitExceeded => e\n+          return render_json_error(I18n.t(\n+            \"invite.rate_limit\",\n+            count: SiteSetting.max_invites_per_day,\n+            time_left: e.time_left\n+          ))\n+        end\n       end\n \n       render json: success_json.merge!("
    },
    {
      "sha": "ba78980f2c83fed5e8a5cd1046b3d8de00b1bb3e",
      "filename": "config/locales/client.en.yml",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "blob_url": "https://github.com/discourse/discourse/blob/38af28d58bd1652d524306e8fe170178115ce43e/config/locales/client.en.yml",
      "raw_url": "https://github.com/discourse/discourse/raw/38af28d58bd1652d524306e8fe170178115ce43e/config/locales/client.en.yml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/locales/client.en.yml?ref=38af28d58bd1652d524306e8fe170178115ce43e",
      "patch": "@@ -660,8 +660,12 @@ en:\n       add_members:\n         title: \"Add members to %{group_name}\"\n         description: \"You can also paste in a comma separated list.\"\n-        usernames: \"Enter usernames or email addresses\"\n-        input_placeholder: \"Usernames or emails\"\n+        usernames_or_emails:\n+          title: \"Enter usernames or email addresses\"\n+          input_placeholder: \"Usernames or emails\"\n+        usernames:\n+          title: \"Enter usernames\"\n+          input_placeholder: \"Usernames\"\n         notify_users: \"Notify users\"\n       requests:\n         title: \"Requests\""
    },
    {
      "sha": "977b2836ec122f2b9e34fef69d21dde57155fde7",
      "filename": "config/locales/server.en.yml",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/discourse/discourse/blob/38af28d58bd1652d524306e8fe170178115ce43e/config/locales/server.en.yml",
      "raw_url": "https://github.com/discourse/discourse/raw/38af28d58bd1652d524306e8fe170178115ce43e/config/locales/server.en.yml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/locales/server.en.yml?ref=38af28d58bd1652d524306e8fe170178115ce43e",
      "patch": "@@ -243,6 +243,9 @@ en:\n     user_exists: \"There's no need to invite <b>%{email}</b>, they <a href='%{base_path}/u/%{username}/summary'>already have an account!</a>\"\n     invite_exists: \"You already invited <b>%{email}</b>.\"\n     invalid_email: \"%{email} isn't a valid email address.\"\n+    rate_limit:\n+      one: \"You have already sent %{count} invite in the last day, please wait %{time_left} before trying again.\"\n+      other: \"You have already sent %{count} invites in the last day, please wait %{time_left} before trying again.\"\n     confirm_email: \"<p>You’re almost done! We sent an activation mail to your email address. Please follow the instructions in the mail to activate your account.</p><p>If it doesn’t arrive, check your spam folder.</p>\"\n     cant_invite_to_group: \"You are not allowed to invite users to specified group(s). Make sure you are owner of the group(s) you are trying to invite to.\"\n     disabled_errors:"
    },
    {
      "sha": "8aa4532430e9f803abf62e66916b664f111bc263",
      "filename": "lib/rate_limiter/limit_exceeded.rb",
      "status": "modified",
      "additions": 4,
      "deletions": 2,
      "changes": 6,
      "blob_url": "https://github.com/discourse/discourse/blob/38af28d58bd1652d524306e8fe170178115ce43e/lib/rate_limiter/limit_exceeded.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/38af28d58bd1652d524306e8fe170178115ce43e/lib/rate_limiter/limit_exceeded.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/rate_limiter/limit_exceeded.rb?ref=38af28d58bd1652d524306e8fe170178115ce43e",
      "patch": "@@ -11,8 +11,8 @@ def initialize(available_in, type = nil)\n       @type = type\n     end\n \n-    def description\n-      time_left =\n+    def time_left\n+      @time_left ||=\n         if @available_in <= 3\n           I18n.t(\"rate_limiter.short_time\")\n         elsif @available_in < 1.minute.to_i\n@@ -22,7 +22,9 @@ def description\n         else\n           I18n.t(\"rate_limiter.hours\", count: (@available_in / 1.hour.to_i))\n         end\n+    end\n \n+    def description\n       if @type.present?\n         type_key = @type.tr(\"-\", \"_\")\n         msg = I18n.t(\"rate_limiter.by_type.#{type_key}\", time_left: time_left, default: \"\")"
    }
  ]
}
