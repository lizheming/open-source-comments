{
  "sha": "657dff354494ed5906beb6fb9e2134c3e0f78792",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo2NTdkZmYzNTQ0OTRlZDU5MDZiZWI2ZmI5ZTIxMzRjM2UwZjc4Nzky",
  "commit": {
    "author": {
      "name": "David Taylor",
      "email": "david@taylorhq.com",
      "date": "2021-04-27T11:30:29Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2021-04-27T11:30:29Z"
    },
    "message": "PERF: Remove N+1s from ThemeController#update and #show (#12842)\n\nThese endpoints only return one `Theme` row, but the one-many relations were not being preloaded efficiently. This commit moves the `includes` statement to a scope, and makes use of it in `#index`, `#show`, and `#update`.",
    "tree": {
      "sha": "2d5773319d9775832e7e75e4e4198dcbc218e034",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/2d5773319d9775832e7e75e4e4198dcbc218e034"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/657dff354494ed5906beb6fb9e2134c3e0f78792",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgh/XVCRBK7hj4Ov3rIwAAZXgIACDLmgp/gOAmwlmLfEyCCMvw\nXc9pr9z/uw3hHoQ1uufzJM8PWRZdQWR9RBoPW2wrUIpSfGRNhlmu884KNv9z/oKT\noNJbS61GJWNXh3qTBUNq0ZWOkoL6E03HcTnd63NoQ7Oyh65Yi9Xcf5PmK6R3Z6c/\nF+9d5eoVH+cb3hY+JJwCsrvh+iQC7toD7lB4ylUqv8G1apRvsIH20dEZYmH1aG5h\n/Pgf528U4xRlhAckdmIK8V4+vMfwkePJQ2irm9eRlmats2MIoOPgdg/2AD+68b52\nuf5E7YXdsjhppVdPqJpZeKDRSUEtxKh4jmRXtwX//a3DYy23iJZumbYUVpLKakI=\n=oLuW\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 2d5773319d9775832e7e75e4e4198dcbc218e034\nparent 40e545dc306cc2e61938e3a1c31425e889e69c1c\nauthor David Taylor <david@taylorhq.com> 1619523029 +0100\ncommitter GitHub <noreply@github.com> 1619523029 +0100\n\nPERF: Remove N+1s from ThemeController#update and #show (#12842)\n\nThese endpoints only return one `Theme` row, but the one-many relations were not being preloaded efficiently. This commit moves the `includes` statement to a scope, and makes use of it in `#index`, `#show`, and `#update`."
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/657dff354494ed5906beb6fb9e2134c3e0f78792",
  "html_url": "https://github.com/discourse/discourse/commit/657dff354494ed5906beb6fb9e2134c3e0f78792",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/657dff354494ed5906beb6fb9e2134c3e0f78792/comments",
  "author": {
    "login": "davidtaylorhq",
    "id": 6270921,
    "node_id": "MDQ6VXNlcjYyNzA5MjE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6270921?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/davidtaylorhq",
    "html_url": "https://github.com/davidtaylorhq",
    "followers_url": "https://api.github.com/users/davidtaylorhq/followers",
    "following_url": "https://api.github.com/users/davidtaylorhq/following{/other_user}",
    "gists_url": "https://api.github.com/users/davidtaylorhq/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/davidtaylorhq/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/davidtaylorhq/subscriptions",
    "organizations_url": "https://api.github.com/users/davidtaylorhq/orgs",
    "repos_url": "https://api.github.com/users/davidtaylorhq/repos",
    "events_url": "https://api.github.com/users/davidtaylorhq/events{/privacy}",
    "received_events_url": "https://api.github.com/users/davidtaylorhq/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "40e545dc306cc2e61938e3a1c31425e889e69c1c",
      "url": "https://api.github.com/repos/discourse/discourse/commits/40e545dc306cc2e61938e3a1c31425e889e69c1c",
      "html_url": "https://github.com/discourse/discourse/commit/40e545dc306cc2e61938e3a1c31425e889e69c1c"
    }
  ],
  "stats": {
    "total": 30,
    "additions": 17,
    "deletions": 13
  },
  "files": [
    {
      "sha": "95f9bbe1e12a3f51d046cdb7ed5d402f472febf9",
      "filename": "app/controllers/admin/themes_controller.rb",
      "status": "modified",
      "additions": 4,
      "deletions": 13,
      "changes": 17,
      "blob_url": "https://github.com/discourse/discourse/blob/657dff354494ed5906beb6fb9e2134c3e0f78792/app/controllers/admin/themes_controller.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/657dff354494ed5906beb6fb9e2134c3e0f78792/app/controllers/admin/themes_controller.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/controllers/admin/themes_controller.rb?ref=657dff354494ed5906beb6fb9e2134c3e0f78792",
      "patch": "@@ -128,16 +128,7 @@ def import\n   end\n \n   def index\n-    @themes = Theme.order(:name).includes(:child_themes,\n-                                          :parent_themes,\n-                                          :remote_theme,\n-                                          :theme_settings,\n-                                          :settings_field,\n-                                          :locale_fields,\n-                                          :user,\n-                                          :color_scheme,\n-                                          theme_fields: :upload\n-                                          )\n+    @themes = Theme.include_relations.order(:name)\n     @color_schemes = ColorScheme.all.includes(:theme, color_scheme_colors: :color_scheme).to_a\n \n     payload = {\n@@ -175,7 +166,7 @@ def create\n   end\n \n   def update\n-    @theme = Theme.find_by(id: params[:id])\n+    @theme = Theme.include_relations.find_by(id: params[:id])\n     raise Discourse::InvalidParameters.new(:id) unless @theme\n \n     original_json = ThemeSerializer.new(@theme, root: false).to_json\n@@ -213,7 +204,7 @@ def update\n       if @theme.save\n         update_default_theme\n \n-        @theme.reload\n+        @theme = Theme.include_relations.find(@theme.id)\n \n         if (!disables_component && !enables_component) || theme_params.keys.size > 1\n           log_theme_change(original_json, @theme)\n@@ -249,7 +240,7 @@ def destroy\n   end\n \n   def show\n-    @theme = Theme.find_by(id: params[:id])\n+    @theme = Theme.include_relations.find_by(id: params[:id])\n     raise Discourse::InvalidParameters.new(:id) unless @theme\n \n     render json: ThemeSerializer.new(@theme)"
    },
    {
      "sha": "3c5ce5493446226f8bda89a71d29cbcf68162a37",
      "filename": "app/models/theme.rb",
      "status": "modified",
      "additions": 13,
      "deletions": 0,
      "changes": 13,
      "blob_url": "https://github.com/discourse/discourse/blob/657dff354494ed5906beb6fb9e2134c3e0f78792/app/models/theme.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/657dff354494ed5906beb6fb9e2134c3e0f78792/app/models/theme.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/theme.rb?ref=657dff354494ed5906beb6fb9e2134c3e0f78792",
      "patch": "@@ -38,6 +38,19 @@ class Theme < ActiveRecord::Base\n     where('user_selectable OR id = ?', SiteSetting.default_theme_id)\n   }\n \n+  scope :include_relations, -> {\n+    includes(:child_themes,\n+      :parent_themes,\n+      :remote_theme,\n+      :theme_settings,\n+      :settings_field,\n+      :locale_fields,\n+      :user,\n+      :color_scheme,\n+      theme_fields: :upload\n+    )\n+  }\n+\n   def notify_color_change(color, scheme: nil)\n     scheme ||= color.color_scheme\n     changed_colors << color if color"
    }
  ]
}
