{
  "sha": "02f3ea0658680ce200258bc66d509403846b62d5",
  "node_id": "C_kwDOAF-mA9oAKDAyZjNlYTA2NTg2ODBjZTIwMDI1OGJjNjZkNTA5NDAzODQ2YjYyZDU",
  "commit": {
    "author": {
      "name": "Pelle Nilsson",
      "email": "pellenilsson@fastmail.fm",
      "date": "2022-02-06T21:04:31Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2022-02-06T21:04:31Z"
    },
    "message": "Have client read out shared settings from server (#311) (#311)\n\nThe following settings are sent as a config object from the\r\nserver to the client:\r\n- `reply-to-self`\r\n- `require-author`\r\n- `require-email`\r\n- `reply-notifications`\r\n- `gravatar`\r\n\r\nThis means that the following settings will be ignored when\r\nset on the client side:\r\n- `data-isso-reply-to-self`\r\n- `data-isso-require-author`\r\n- `data-isso-require-email`\r\n- `data-isso-reply-notifications`\r\n- `data-isso-gravatar`\r\n\r\nIsso will notify the user on the browser console if a client\r\nsetting has been overwritten by a config from the server.\r\n\r\nGravatar setting trumps regular avatars:\r\nIn addition, `data-isso-avatar` will be set to `false` when\r\ngravatars are enabled to prevent both regular avatars and\r\ngravatars appearing side-by-side.\r\n\r\nDocumentation updates:\r\nUpdate docs for shared server-client settings and clarify\r\ndocumentation for gravatar/avatar settings",
    "tree": {
      "sha": "e2ab71343933d9c35370668892bf05449537fe59",
      "url": "https://api.github.com/repos/posativ/isso/git/trees/e2ab71343933d9c35370668892bf05449537fe59"
    },
    "url": "https://api.github.com/repos/posativ/isso/git/commits/02f3ea0658680ce200258bc66d509403846b62d5",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiADffCRBK7hj4Ov3rIwAApPkIAAl7gEveVCIe86INv8WvezDX\nVy+xSpPfa1AbxGzresuRqyaRzDZoTZBfxOpqKcnMJmBf/es2K8uc3vu4ZLGg/en0\nOEhfaDWWLLvrtP7W/cPUvhSOQ+5r/IIGtA5b9PYd4U4DmZwm2KMn4abuFrVyDKsk\nqKRN8IkzO6sHBJpGtmACTI4qxxzV7hLUI+gmXHjq71JEKQQNw/Vks1LuUeYcQt+Z\nDGEdDw2gJHeFXQuZtMApeWQ4PI1JpeJ9I16GFpO0aMXsWjsEkaNkTC/SBmxREncB\n1WiKIL5W/4egJPKTJ4XAIccCZAs+1aFCCQQv8i+7a5nDCu8LiiG9v9kxl+/1ouo=\n=k3Fp\n-----END PGP SIGNATURE-----\n",
      "payload": "tree e2ab71343933d9c35370668892bf05449537fe59\nparent 48a473606e20ec2afd139858164fc5550a0375dc\nauthor Pelle Nilsson <pellenilsson@fastmail.fm> 1644181471 +0100\ncommitter GitHub <noreply@github.com> 1644181471 +0100\n\nHave client read out shared settings from server (#311) (#311)\n\nThe following settings are sent as a config object from the\r\nserver to the client:\r\n- `reply-to-self`\r\n- `require-author`\r\n- `require-email`\r\n- `reply-notifications`\r\n- `gravatar`\r\n\r\nThis means that the following settings will be ignored when\r\nset on the client side:\r\n- `data-isso-reply-to-self`\r\n- `data-isso-require-author`\r\n- `data-isso-require-email`\r\n- `data-isso-reply-notifications`\r\n- `data-isso-gravatar`\r\n\r\nIsso will notify the user on the browser console if a client\r\nsetting has been overwritten by a config from the server.\r\n\r\nGravatar setting trumps regular avatars:\r\nIn addition, `data-isso-avatar` will be set to `false` when\r\ngravatars are enabled to prevent both regular avatars and\r\ngravatars appearing side-by-side.\r\n\r\nDocumentation updates:\r\nUpdate docs for shared server-client settings and clarify\r\ndocumentation for gravatar/avatar settings"
    }
  },
  "url": "https://api.github.com/repos/posativ/isso/commits/02f3ea0658680ce200258bc66d509403846b62d5",
  "html_url": "https://github.com/posativ/isso/commit/02f3ea0658680ce200258bc66d509403846b62d5",
  "comments_url": "https://api.github.com/repos/posativ/isso/commits/02f3ea0658680ce200258bc66d509403846b62d5/comments",
  "author": {
    "login": "pellenilsson",
    "id": 8751300,
    "node_id": "MDQ6VXNlcjg3NTEzMDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8751300?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pellenilsson",
    "html_url": "https://github.com/pellenilsson",
    "followers_url": "https://api.github.com/users/pellenilsson/followers",
    "following_url": "https://api.github.com/users/pellenilsson/following{/other_user}",
    "gists_url": "https://api.github.com/users/pellenilsson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pellenilsson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pellenilsson/subscriptions",
    "organizations_url": "https://api.github.com/users/pellenilsson/orgs",
    "repos_url": "https://api.github.com/users/pellenilsson/repos",
    "events_url": "https://api.github.com/users/pellenilsson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pellenilsson/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "48a473606e20ec2afd139858164fc5550a0375dc",
      "url": "https://api.github.com/repos/posativ/isso/commits/48a473606e20ec2afd139858164fc5550a0375dc",
      "html_url": "https://github.com/posativ/isso/commit/48a473606e20ec2afd139858164fc5550a0375dc"
    }
  ],
  "stats": {
    "total": 120,
    "additions": 77,
    "deletions": 43
  },
  "files": [
    {
      "sha": "a49814bf6e909f8b6e2fe2f3ef17e91bda1bd7b4",
      "filename": "CHANGES.rst",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/posativ/isso/blob/02f3ea0658680ce200258bc66d509403846b62d5/CHANGES.rst",
      "raw_url": "https://github.com/posativ/isso/raw/02f3ea0658680ce200258bc66d509403846b62d5/CHANGES.rst",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/CHANGES.rst?ref=02f3ea0658680ce200258bc66d509403846b62d5",
      "patch": "@@ -18,6 +18,16 @@ Changelog for Isso\n \n - Fallback for SameSite header depending on whether host is served over https\n   or http (#700, ix5)\n+- Have client read out shared settings from server. (#311, pellenilsson)\n+  This affects these settings for which ``data-isso-*`` values will be ignored:\n+\n+    [general]\n+    reply-notifications\n+    gravatar\n+    [guard]\n+    reply-to-self\n+    require-author\n+    require-email\n \n - Improved detection of browser-supplied language preferences (#521)\n   Isso will now honor the newer `navigator.languages` global property"
    },
    {
      "sha": "45938354f1655aa5a96f62bd80dac5960486fb75",
      "filename": "docs/docs/configuration/client.rst",
      "status": "modified",
      "additions": 38,
      "deletions": 33,
      "changes": 71,
      "blob_url": "https://github.com/posativ/isso/blob/02f3ea0658680ce200258bc66d509403846b62d5/docs/docs/configuration/client.rst",
      "raw_url": "https://github.com/posativ/isso/raw/02f3ea0658680ce200258bc66d509403846b62d5/docs/docs/configuration/client.rst",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/docs/docs/configuration/client.rst?ref=02f3ea0658680ce200258bc66d509403846b62d5",
      "patch": "@@ -11,10 +11,6 @@ preferably in the script tag which embeds the JS:\n             data-isso-css=\"true\"\n             data-isso-css-url=\"null\"\n             data-isso-lang=\"ru\"\n-            data-isso-reply-to-self=\"false\"\n-            data-isso-require-author=\"false\"\n-            data-isso-require-email=\"false\"\n-            data-isso-reply-notifications=\"false\"\n             data-isso-max-comments-top=\"10\"\n             data-isso-max-comments-nested=\"5\"\n             data-isso-reveal-on-click=\"5\"\n@@ -148,26 +144,6 @@ be a BCP 47 language tag.  Defaults to \"en\".\n If you specify both ``data-isso-default-lang`` and ``data-isso-lang``,\n ``data-isso-lang`` takes precedence.\n \n-data-isso-reply-to-self\n------------------------\n-\n-Set to `true` when spam guard is configured with `reply-to-self = true`.\n-\n-data-isso-require-author\n-------------------------\n-\n-Set to `true` when spam guard is configured with `require-author = true`.\n-\n-data-isso-require-email\n------------------------\n-\n-Set to `true` when spam guard is configured with `require-email = true`.\n-\n-data-isso-reply-notifications\n------------------------------\n-\n-Set to `true` when reply notifications is configured with `reply-notifications = true`.\n-\n data-isso-max-comments-top and data-isso-max-comments-nested\n ------------------------------------------------------------\n \n@@ -184,7 +160,9 @@ Number of comments to reveal on clicking the \"X Hidden\" link.\n data-isso-avatar\n ----------------\n \n-Enable or disable avatar generation.\n+Enable or disable avatar generation. Ignored if gravatar is enabled on\n+server side, since gravatars will take precedence and disable avatar\n+generation.\n \n data-isso-avatar-bg\n -------------------\n@@ -199,14 +177,6 @@ scheme is based in `this color palette <http://colrd.com/palette/19308/>`_.\n Multiple colors must be separated by space. If you use less than eight colors\n and not a multiple of 2, the color distribution is not even.\n \n-data-isso-gravatar\n-------------------\n-\n-Uses gravatar images instead of generating svg images. You have to set\n-\"data-isso-avatar\" to **false** when you want to use this. Otherwise\n-both the gravatar and avatar svg image will show up. Please also set\n-option \"gravatar\" to **true** in the server configuration...\n-\n data-isso-vote\n --------------\n \n@@ -232,3 +202,38 @@ data-isso-feed\n Enable or disable the addition of a link to the feed for the comment\n thread. The link will only be valid if the appropriate setting, in\n ``[rss]`` section, is also enabled server-side.\n+\n+\n+\n+Deprecated Client Settings\n+==========================\n+\n+In earlier versions the following settings had to mirror the\n+corresponding settings in the server configuration, but they are now\n+read out from the server automatically.\n+\n+data-isso-reply-to-self\n+-----------------------\n+\n+Set to `true` when spam guard is configured with `reply-to-self = true`.\n+\n+data-isso-require-author\n+------------------------\n+\n+Set to `true` when spam guard is configured with `require-author = true`.\n+\n+data-isso-require-email\n+-----------------------\n+\n+Set to `true` when spam guard is configured with `require-email = true`.\n+\n+data-isso-reply-notifications\n+-----------------------------\n+\n+Set to `true` when reply notifications is configured with `reply-notifications = true`.\n+\n+data-isso-gravatar\n+------------------\n+\n+Set to `true` when gravatars are enabled with `gravatar = true` in the\n+server configuration."
    },
    {
      "sha": "37f820e6564ec0cb9b16427189bc80fece9b97bb",
      "filename": "docs/docs/configuration/server.rst",
      "status": "modified",
      "additions": 0,
      "deletions": 8,
      "changes": 8,
      "blob_url": "https://github.com/posativ/isso/blob/02f3ea0658680ce200258bc66d509403846b62d5/docs/docs/configuration/server.rst",
      "raw_url": "https://github.com/posativ/isso/raw/02f3ea0658680ce200258bc66d509403846b62d5/docs/docs/configuration/server.rst",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/docs/docs/configuration/server.rst?ref=02f3ea0658680ce200258bc66d509403846b62d5",
      "patch": "@@ -95,8 +95,6 @@ reply-notifications\n     It is highly recommended to also turn on moderation when enabling this\n     setting, as Isso can otherwise be easily exploited for sending spam.\n \n-    Do not forget to configure the client accordingly.\n-\n log-file\n     Log console messages to file instead of standard out.\n \n@@ -297,20 +295,14 @@ reply-to-self\n     the comment. After the editing timeframe is gone, commenters can reply to\n     their own comments anyways.\n \n-    Do not forget to configure the `client <client>`_ accordingly\n-\n require-author\n     force commenters to enter a value into the author field. No validation is\n     performed on the provided value.\n \n-    Do not forget to configure the `client <client>`_ accordingly.\n-\n require-email\n     force commenters to enter a value into the email field. No validation is\n     performed on the provided value.\n \n-    Do not forget to configure the `client <client>`_ accordingly.\n-\n .. _configure-markup:\n \n Markup"
    },
    {
      "sha": "dbca15e88fb7bff7c56b8a9d97e343a3a6d97415",
      "filename": "isso/js/embed.js",
      "status": "modified",
      "additions": 16,
      "deletions": 1,
      "changes": 17,
      "blob_url": "https://github.com/posativ/isso/blob/02f3ea0658680ce200258bc66d509403846b62d5/isso/js/embed.js",
      "raw_url": "https://github.com/posativ/isso/raw/02f3ea0658680ce200258bc66d509403846b62d5/isso/js/embed.js",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/isso/js/embed.js?ref=02f3ea0658680ce200258bc66d509403846b62d5",
      "patch": "@@ -41,8 +41,10 @@ require([\"app/lib/ready\", \"app/config\", \"app/i18n\", \"app/api\", \"app/isso\", \"app/\n             feedLinkWrapper.appendChild(feedLink);\n             isso_thread.append(feedLinkWrapper);\n         }\n+        // Note: Not appending the isso.Postbox here since it relies\n+        // on the config object populated by elements fetched from the server,\n+        // and the call to fetch those is in fetchComments()\n         isso_thread.append(heading);\n-        isso_thread.append(new isso.Postbox(null));\n         isso_thread.append('<div id=\"isso-root\"></div>');\n     }\n \n@@ -57,6 +59,19 @@ require([\"app/lib/ready\", \"app/config\", \"app/i18n\", \"app/api\", \"app/isso\", \"app/\n             config[\"max-comments-top\"],\n             config[\"max-comments-nested\"]).then(\n             function (rv) {\n+                for (var setting in rv.config) {\n+                    if (setting in config && config[setting] != rv.config[setting]) {\n+                        console.log(\"Isso: Client value '%s' for setting '%s' overridden by server value '%s'.\\n\" +\n+                                    \"Since Isso version 0.12.6, 'data-isso-%s' is only configured via the server \" +\n+                                    \"to keep client and server in sync\",\n+                                    config[setting], setting, rv.config[setting], setting);\n+                    }\n+                    config[setting] = rv.config[setting]\n+                }\n+\n+                // Finally, create Postbox with configs fetched from server\n+                isso_thread.append(new isso.Postbox(null));\n+\n                 if (rv.total_replies === 0) {\n                     heading.textContent = i18n.translate(\"no-comments\");\n                     return;"
    },
    {
      "sha": "9f5192c796661682528e7bcb13e6b73883735cc4",
      "filename": "isso/views/comments.py",
      "status": "modified",
      "additions": 13,
      "deletions": 1,
      "changes": 14,
      "blob_url": "https://github.com/posativ/isso/blob/02f3ea0658680ce200258bc66d509403846b62d5/isso/views/comments.py",
      "raw_url": "https://github.com/posativ/isso/raw/02f3ea0658680ce200258bc66d509403846b62d5/isso/views/comments.py",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/isso/views/comments.py?ref=02f3ea0658680ce200258bc66d509403846b62d5",
      "patch": "@@ -138,6 +138,17 @@ def __init__(self, isso, hasher):\n         except NoOptionError:\n             self.trusted_proxies = []\n \n+        # These configuration records can be read out by client\n+        self.public_conf = {}\n+        self.public_conf[\"reply-to-self\"] = isso.conf.getboolean(\"guard\", \"reply-to-self\")\n+        self.public_conf[\"require-email\"] = isso.conf.getboolean(\"guard\", \"require-email\")\n+        self.public_conf[\"require-author\"] = isso.conf.getboolean(\"guard\", \"require-author\")\n+        self.public_conf[\"reply-notifications\"] = isso.conf.getboolean(\"general\", \"reply-notifications\")\n+        self.public_conf[\"gravatar\"] = isso.conf.getboolean(\"general\", \"gravatar\")\n+\n+        if self.public_conf[\"gravatar\"]:\n+            self.public_conf[\"avatar\"] = False\n+\n         self.guard = isso.db.guard\n         self.threads = isso.db.threads\n         self.comments = isso.db.comments\n@@ -833,7 +844,8 @@ def fetch(self, environ, request, uri):\n             'id': root_id,\n             'total_replies': reply_counts[root_id],\n             'hidden_replies': reply_counts[root_id] - len(root_list),\n-            'replies': self._process_fetched_list(root_list, plain)\n+            'replies': self._process_fetched_list(root_list, plain),\n+            'config': self.public_conf\n         }\n         # We are only checking for one level deep comments\n         if root_id is None:"
    }
  ]
}
