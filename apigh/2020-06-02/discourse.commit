{
  "sha": "439db7ca1ece96819948c3abd3b61e9927200087",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo0MzlkYjdjYTFlY2U5NjgxOTk0OGMzYWJkM2I2MWU5OTI3MjAwMDg3",
  "commit": {
    "author": {
      "name": "Guo Xiang Tan",
      "email": "gxtan1990@gmail.com",
      "date": "2020-06-02T09:24:14Z"
    },
    "committer": {
      "name": "Guo Xiang Tan",
      "email": "gxtan1990@gmail.com",
      "date": "2020-06-02T09:24:14Z"
    },
    "message": "DEV: Add `REDIS_RAILS_FAILOVER` env to test our new redis failover.",
    "tree": {
      "sha": "6f0663630010e0ce8ecdfb74cf0ab43634359343",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/6f0663630010e0ce8ecdfb74cf0ab43634359343"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/439db7ca1ece96819948c3abd3b61e9927200087",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEMOJGkc46I9vMVlDg+9EQF5qsHyAFAl7WGtcACgkQ+9EQF5qs\nHyCurhAAxDWxRju9a/O4ONmWfBSj5GPU6zkoRrm7LWZavULVHnD1aC2ZTl2S+PDb\nv4LTvXgOLQ9NAnodu60AEBt18bK6sNqIQSdTnds/D0UUFrOmjT6ZjiXm+GbSMGCT\npM8BUllSJkZB6o8/AOP9Y8CcAYPnCy5fK3H+0KO3IcVsuNExuLO3e7dBocg3bZiT\nKQmkfFwtSCHLDm26xsQYLcalOKJfRPj6VCWuySXOk6neKfVqTX4t1OOLFxCJj8hy\nZH7Y7s++aWmijuRjw3wv8zTqmymg45e+SeoCllWONvxBW4Av6fU2xEGluOXqO9ze\nWbBNsZUZe2tnPQtTLQkY7ARTDWU5ULD6fQHM9qh/IlsGt+F3NbkvuUH6SiyweBft\ngF9KPS/bZOxWbi/Laj8+LKh9wawl2NnKuwEXZjEj+xODiUo0u+4+l60CKjOURz8e\nMUXxmqBYsAMIqgiCS2cO9E1l2338IJSbm9EPSe3xVKzK2ZX2npQcTgJfBxLGMn3d\nUuvcEDxm+KiPaAGC4rnqI58+Vz62+5DObHhWX+5bGh0Jmv73Gksrs9UY2AKehpSX\nki1qfG3PKAZa+JIob+IFd7kvgP7jNJ3YbdY72Y1ezDmYBgc5gHhVKLRaGlHwhVA8\n6kXI3qnay3tSkHRBDhsIN0RReBwAY2Kzp0/+UH/Ie8nlVc7c53k=\n=IzW8\n-----END PGP SIGNATURE-----",
      "payload": "tree 6f0663630010e0ce8ecdfb74cf0ab43634359343\nparent deb84017f2f48faf337446a4b76952934fb8d042\nauthor Guo Xiang Tan <gxtan1990@gmail.com> 1591089854 +0800\ncommitter Guo Xiang Tan <gxtan1990@gmail.com> 1591089854 +0800\n\nDEV: Add `REDIS_RAILS_FAILOVER` env to test our new redis failover.\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/439db7ca1ece96819948c3abd3b61e9927200087",
  "html_url": "https://github.com/discourse/discourse/commit/439db7ca1ece96819948c3abd3b61e9927200087",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/439db7ca1ece96819948c3abd3b61e9927200087/comments",
  "author": {
    "login": "tgxworld",
    "id": 4335742,
    "node_id": "MDQ6VXNlcjQzMzU3NDI=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/4335742?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tgxworld",
    "html_url": "https://github.com/tgxworld",
    "followers_url": "https://api.github.com/users/tgxworld/followers",
    "following_url": "https://api.github.com/users/tgxworld/following{/other_user}",
    "gists_url": "https://api.github.com/users/tgxworld/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tgxworld/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tgxworld/subscriptions",
    "organizations_url": "https://api.github.com/users/tgxworld/orgs",
    "repos_url": "https://api.github.com/users/tgxworld/repos",
    "events_url": "https://api.github.com/users/tgxworld/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tgxworld/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tgxworld",
    "id": 4335742,
    "node_id": "MDQ6VXNlcjQzMzU3NDI=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/4335742?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tgxworld",
    "html_url": "https://github.com/tgxworld",
    "followers_url": "https://api.github.com/users/tgxworld/followers",
    "following_url": "https://api.github.com/users/tgxworld/following{/other_user}",
    "gists_url": "https://api.github.com/users/tgxworld/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tgxworld/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tgxworld/subscriptions",
    "organizations_url": "https://api.github.com/users/tgxworld/orgs",
    "repos_url": "https://api.github.com/users/tgxworld/repos",
    "events_url": "https://api.github.com/users/tgxworld/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tgxworld/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "deb84017f2f48faf337446a4b76952934fb8d042",
      "url": "https://api.github.com/repos/discourse/discourse/commits/deb84017f2f48faf337446a4b76952934fb8d042",
      "html_url": "https://github.com/discourse/discourse/commit/deb84017f2f48faf337446a4b76952934fb8d042"
    }
  ],
  "stats": {
    "total": 46,
    "additions": 38,
    "deletions": 8
  },
  "files": [
    {
      "sha": "92e1f2a4a7aa4392371e8e97c35ec9198acda949",
      "filename": "Gemfile.lock",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/439db7ca1ece96819948c3abd3b61e9927200087/Gemfile.lock",
      "raw_url": "https://github.com/discourse/discourse/raw/439db7ca1ece96819948c3abd3b61e9927200087/Gemfile.lock",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/Gemfile.lock?ref=439db7ca1ece96819948c3abd3b61e9927200087",
      "patch": "@@ -1,6 +1,6 @@\n GIT\n   remote: https://github.com/discourse/rails_failover\n-  revision: 291bf1c18e9a704556a40204d8160549d0438e96\n+  revision: 73ceb21624079e007a7d3bf0bf201f0b34dcd6aa\n   specs:\n     rails_failover (0.4.0)\n       activerecord (~> 6.0)"
    },
    {
      "sha": "cd80df668189bb9ba40c34a3c9ce7c7a09143cbc",
      "filename": "app/models/global_setting.rb",
      "status": "modified",
      "additions": 18,
      "deletions": 6,
      "changes": 24,
      "blob_url": "https://github.com/discourse/discourse/blob/439db7ca1ece96819948c3abd3b61e9927200087/app/models/global_setting.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/439db7ca1ece96819948c3abd3b61e9927200087/app/models/global_setting.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/global_setting.rb?ref=439db7ca1ece96819948c3abd3b61e9927200087",
      "patch": "@@ -169,9 +169,15 @@ def self.redis_config\n         c[:port] = redis_port if redis_port\n \n         if redis_slave_host && redis_slave_port\n-          c[:slave_host] = redis_slave_host\n-          c[:slave_port] = redis_slave_port\n-          c[:connector] = DiscourseRedis::Connector\n+          if ENV[\"REDIS_RAILS_FAILOVER\"]\n+            c[:replica_host] = redis_slave_host\n+            c[:replica_port] = redis_slave_port\n+            c[:connector] = RailsFailover::Redis::Connector\n+          else\n+            c[:slave_host] = redis_slave_host\n+            c[:slave_port] = redis_slave_port\n+            c[:connector] = DiscourseRedis::Connector\n+          end\n         end\n \n         c[:password] = redis_password if redis_password.present?\n@@ -193,9 +199,15 @@ def self.message_bus_redis_config\n         c[:port] = message_bus_redis_port if message_bus_redis_port\n \n         if message_bus_redis_slave_host && message_bus_redis_slave_port\n-          c[:slave_host] = message_bus_redis_slave_host\n-          c[:slave_port] = message_bus_redis_slave_port\n-          c[:connector] = DiscourseRedis::Connector\n+          if ENV[\"REDIS_RAILS_FAILOVER\"]\n+            c[:replica_host] = redis_slave_host\n+            c[:replica_port] = redis_slave_port\n+            c[:connector] = RailsFailover::Redis::Connector\n+          else\n+            c[:slave_host] = message_bus_redis_slave_host\n+            c[:slave_port] = message_bus_redis_slave_port\n+            c[:connector] = DiscourseRedis::Connector\n+          end\n         end\n \n         c[:password] = message_bus_redis_password if message_bus_redis_password.present?"
    },
    {
      "sha": "07730bc63b568daec83ff542d7c50e237d151e75",
      "filename": "config/application.rb",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/discourse/discourse/blob/439db7ca1ece96819948c3abd3b61e9927200087/config/application.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/439db7ca1ece96819948c3abd3b61e9927200087/config/application.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/application.rb?ref=439db7ca1ece96819948c3abd3b61e9927200087",
      "patch": "@@ -31,6 +31,10 @@\n   require 'rails_failover/active_record'\n end\n \n+if ENV['REDIS_RAILS_FAILOVER']\n+  require 'rails_failover/redis'\n+end\n+\n # Global config\n require_relative '../app/models/global_setting'\n GlobalSetting.configure!"
    },
    {
      "sha": "5b65d579f1910a8bdc9fa035a3538f38c3ce7968",
      "filename": "config/initializers/002-rails_failover.rb",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/discourse/discourse/blob/439db7ca1ece96819948c3abd3b61e9927200087/config/initializers/002-rails_failover.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/439db7ca1ece96819948c3abd3b61e9927200087/config/initializers/002-rails_failover.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/initializers/002-rails_failover.rb?ref=439db7ca1ece96819948c3abd3b61e9927200087",
      "patch": "@@ -1,5 +1,16 @@\n # frozen_string_literal: true\n \n+if ENV[\"REDIS_RAILS_FAILOVER\"]\n+  RailsFailover::Redis.on_failover do\n+    Discourse.received_redis_readonly!\n+  end\n+\n+  RailsFailover::Redis.on_fallback do\n+    Discourse.clear_readonly!\n+    Discourse.request_refresh!\n+  end\n+end\n+\n if ENV[\"ACTIVE_RECORD_RAILS_FAILOVER\"]\n   RailsFailover::ActiveRecord.on_failover do\n     RailsMultisite::ConnectionManagement.each_connection do"
    },
    {
      "sha": "b172c02d1221fbf2eef3ae79a6d9dba3ca74c777",
      "filename": "lib/discourse_redis.rb",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/discourse/discourse/blob/439db7ca1ece96819948c3abd3b61e9927200087/lib/discourse_redis.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/439db7ca1ece96819948c3abd3b61e9927200087/lib/discourse_redis.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/discourse_redis.rb?ref=439db7ca1ece96819948c3abd3b61e9927200087",
      "patch": "@@ -176,7 +176,10 @@ def self.ignore_readonly\n         STDERR.puts \"WARN: Redis is in a readonly state. Performed a noop\"\n       end\n \n-      fallback_handler.verify_master if !fallback_handler.master\n+      if !ENV[\"REDIS_RAILS_FAILOVER\"]\n+        fallback_handler.verify_master if !fallback_handler.master\n+      end\n+\n       Discourse.received_redis_readonly!\n       nil\n     else"
    }
  ]
}
