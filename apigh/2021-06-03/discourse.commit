{
  "sha": "4134173bbf5573da5b771de4f852c6df34c5e502",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo0MTM0MTczYmJmNTU3M2RhNWI3NzFkZTRmODUyYzZkZjM0YzVlNTAy",
  "commit": {
    "author": {
      "name": "David Taylor",
      "email": "david@taylorhq.com",
      "date": "2021-06-03T09:52:43Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2021-06-03T09:52:43Z"
    },
    "message": "FEATURE: Add global admin api key rate limiter (#12527)",
    "tree": {
      "sha": "0436c70014f68fafa21f1a3dd7b5594b2cc20111",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/0436c70014f68fafa21f1a3dd7b5594b2cc20111"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/4134173bbf5573da5b771de4f852c6df34c5e502",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJguKZrCRBK7hj4Ov3rIwAAAuQIAHMMtJ9MR2yetP94ovkPD03O\nJrJGtE+wfDMsw7NKwT3A7FasPY35Z9E22S/G6LrrtwDyjIyYc4EKGN/bQNfpx8eQ\nYeSPtJU0oqpr4N2hk73nQVLanLW8BRYv/m+pQ2lF8x6BlrE9dK0QDeBFmh6ECj6O\nlLjH2iR/Hr1OiJK3p4N5suvRmlhTuVI9qCzOYH7RUu609FgeasyMXxd+YPE1Gf+v\nJTTIW1d3dCJ1eFIgoHSdo8on080WlLG/2epSNs8wI52F/tcERdAF8ujyS/AkUwEE\nLwZTsr2idwInOX0QwrADGl6xsLvrpD/bSprUPte5AyFkjMfn71D/WZ6LY+sMNvA=\n=TUiS\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 0436c70014f68fafa21f1a3dd7b5594b2cc20111\nparent 58b30fb5109d0f313b5cde42a0ed103cb9525530\nauthor David Taylor <david@taylorhq.com> 1622713963 +0100\ncommitter GitHub <noreply@github.com> 1622713963 +0100\n\nFEATURE: Add global admin api key rate limiter (#12527)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/4134173bbf5573da5b771de4f852c6df34c5e502",
  "html_url": "https://github.com/discourse/discourse/commit/4134173bbf5573da5b771de4f852c6df34c5e502",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/4134173bbf5573da5b771de4f852c6df34c5e502/comments",
  "author": {
    "login": "davidtaylorhq",
    "id": 6270921,
    "node_id": "MDQ6VXNlcjYyNzA5MjE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6270921?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/davidtaylorhq",
    "html_url": "https://github.com/davidtaylorhq",
    "followers_url": "https://api.github.com/users/davidtaylorhq/followers",
    "following_url": "https://api.github.com/users/davidtaylorhq/following{/other_user}",
    "gists_url": "https://api.github.com/users/davidtaylorhq/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/davidtaylorhq/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/davidtaylorhq/subscriptions",
    "organizations_url": "https://api.github.com/users/davidtaylorhq/orgs",
    "repos_url": "https://api.github.com/users/davidtaylorhq/repos",
    "events_url": "https://api.github.com/users/davidtaylorhq/events{/privacy}",
    "received_events_url": "https://api.github.com/users/davidtaylorhq/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "58b30fb5109d0f313b5cde42a0ed103cb9525530",
      "url": "https://api.github.com/repos/discourse/discourse/commits/58b30fb5109d0f313b5cde42a0ed103cb9525530",
      "html_url": "https://github.com/discourse/discourse/commit/58b30fb5109d0f313b5cde42a0ed103cb9525530"
    }
  ],
  "stats": {
    "total": 32,
    "additions": 21,
    "deletions": 11
  },
  "files": [
    {
      "sha": "e278d790e51858de8e7db96f39260292bd77f55f",
      "filename": "config/discourse_defaults.conf",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/4134173bbf5573da5b771de4f852c6df34c5e502/config/discourse_defaults.conf",
      "raw_url": "https://github.com/discourse/discourse/raw/4134173bbf5573da5b771de4f852c6df34c5e502/config/discourse_defaults.conf",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/discourse_defaults.conf?ref=4134173bbf5573da5b771de4f852c6df34c5e502",
      "patch": "@@ -225,7 +225,7 @@ s3_install_cors_rule =\n max_user_api_reqs_per_minute = 20\n max_user_api_reqs_per_day = 2880\n \n-max_admin_api_reqs_per_key_per_minute = 60\n+max_admin_api_reqs_per_minute = 60\n \n max_reqs_per_ip_per_minute = 200\n max_reqs_per_ip_per_10_seconds = 50"
    },
    {
      "sha": "8c16392b3aa3af59218589bf0a3d0980d6dbded3",
      "filename": "lib/auth/default_current_user_provider.rb",
      "status": "modified",
      "additions": 14,
      "deletions": 6,
      "changes": 20,
      "blob_url": "https://github.com/discourse/discourse/blob/4134173bbf5573da5b771de4f852c6df34c5e502/lib/auth/default_current_user_provider.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/4134173bbf5573da5b771de4f852c6df34c5e502/lib/auth/default_current_user_provider.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/auth/default_current_user_provider.rb?ref=4134173bbf5573da5b771de4f852c6df34c5e502",
      "patch": "@@ -131,7 +131,7 @@ def current_user\n       raise Discourse::InvalidAccess.new(I18n.t('invalid_api_credentials'), nil, custom_message: \"invalid_api_credentials\") unless current_user\n       raise Discourse::InvalidAccess if current_user.suspended? || !current_user.active\n       @env[API_KEY_ENV] = true\n-      rate_limit_admin_api_requests(api_key)\n+      rate_limit_admin_api_requests!\n     end\n \n     # user api key handling\n@@ -377,15 +377,23 @@ def header_api_key?\n     !!@env[HEADER_API_KEY]\n   end\n \n-  def rate_limit_admin_api_requests(api_key)\n+  def rate_limit_admin_api_requests!\n     return if Rails.env == \"profile\"\n \n-    RateLimiter.new(\n+    limit = GlobalSetting.max_admin_api_reqs_per_minute.to_i\n+    if GlobalSetting.respond_to?(:max_admin_api_reqs_per_key_per_minute)\n+      Discourse.deprecate(\"DISCOURSE_MAX_ADMIN_API_REQS_PER_KEY_PER_MINUTE is deprecated. Please use DISCOURSE_MAX_ADMIN_API_REQS_PER_MINUTE\")\n+      limit = [ GlobalSetting.max_admin_api_reqs_per_key_per_minute.to_i, limit].max\n+    end\n+\n+    global_limit = RateLimiter.new(\n       nil,\n-      \"admin_api_min_#{ApiKey.hash_key(api_key)}\",\n-      GlobalSetting.max_admin_api_reqs_per_key_per_minute,\n+      \"admin_api_min\",\n+      limit,\n       60\n-    ).performed!\n+    )\n+\n+    global_limit.performed!\n   end\n \n   def can_write?"
    },
    {
      "sha": "b8da06fc58216c5ed03800527089e8f9305d01fe",
      "filename": "spec/components/auth/default_current_user_provider_spec.rb",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/discourse/discourse/blob/4134173bbf5573da5b771de4f852c6df34c5e502/spec/components/auth/default_current_user_provider_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/4134173bbf5573da5b771de4f852c6df34c5e502/spec/components/auth/default_current_user_provider_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/components/auth/default_current_user_provider_spec.rb?ref=4134173bbf5573da5b771de4f852c6df34c5e502",
      "patch": "@@ -195,10 +195,11 @@ def provider(url, opts = nil)\n         RateLimiter.enable\n       end\n \n-      it \"rate limits api requests per api key\" do\n-        global_setting :max_admin_api_reqs_per_key_per_minute, 3\n+      it \"rate limits admin api requests\" do\n+        global_setting :max_admin_api_reqs_per_minute, 3\n \n         freeze_time\n+        RateLimiter.new(nil, \"admin_api_min\", 3, 60).clear!\n \n         api_key = ApiKey.create!(created_by_id: -1)\n         params = { \"HTTP_API_KEY\" => api_key.key, \"HTTP_API_USERNAME\" => user.username.downcase }"
    },
    {
      "sha": "294bf62b59e59474688c6cab834b158c9c54e5b9",
      "filename": "spec/integration/rate_limiting_spec.rb",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/discourse/discourse/blob/4134173bbf5573da5b771de4f852c6df34c5e502/spec/integration/rate_limiting_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/4134173bbf5573da5b771de4f852c6df34c5e502/spec/integration/rate_limiting_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/integration/rate_limiting_spec.rb?ref=4134173bbf5573da5b771de4f852c6df34c5e502",
      "patch": "@@ -49,12 +49,13 @@\n \n   it 'can cleanly limit requests and sets a Retry-After header' do\n     freeze_time\n-    #request.set_header(\"action_dispatch.show_exceptions\", true)\n+\n+    RateLimiter.clear_all!\n \n     admin = Fabricate(:admin)\n     api_key = Fabricate(:api_key, user: admin)\n \n-    global_setting :max_admin_api_reqs_per_key_per_minute, 1\n+    global_setting :max_admin_api_reqs_per_minute, 1\n \n     get '/admin/api/keys.json', headers: {\n       HTTP_API_KEY: api_key.key,"
    }
  ]
}
