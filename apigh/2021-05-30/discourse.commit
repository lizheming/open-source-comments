{
  "sha": "06e1af2b1d368212df2da9d18a32571b2c30184e",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODowNmUxYWYyYjFkMzY4MjEyZGYyZGE5ZDE4YTMyNTcxYjJjMzAxODRl",
  "commit": {
    "author": {
      "name": "Penar Musaraj",
      "email": "pmusaraj@gmail.com",
      "date": "2021-05-28T19:10:32Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2021-05-28T19:10:32Z"
    },
    "message": "FIX: Giphy oneboxing when the response is an image (#13199)",
    "tree": {
      "sha": "c9d47ee6b756b34072d1e2744be03ef6f2ca4867",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/c9d47ee6b756b34072d1e2744be03ef6f2ca4867"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/06e1af2b1d368212df2da9d18a32571b2c30184e",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgsUAoCRBK7hj4Ov3rIwAA4YoIAFByI04CVkVImD/OvWKmcTX+\nxPgw09Yr5TU5o29wqgh+ERmi1abj/CTVa1zrTQZPDneC49O1AYogmVswxejRI+JN\nFlnCmuZbN0OjlsQ34GGExMM3hrC2zCMvdT1z2Wse6eP43OGM0TiJl2W9YJrN+llb\nr96HwCRzp0Neic3j8b9Sp1UpXDf8uXTvOWkDHwYbbQOHzbyYZp+nEboaDdbwAOiq\nKgC6AQw4XdH089dvMjAeyaT/mAQioGKjVb165MA3XLRb2ghYATnaXjlrAWseirZ1\nf4SI3rQ5BlXj+za8mIao60gSDTLDbkAMTBSjYI8mEhridpmS00dDmKtQ0obRDoo=\n=zClm\n-----END PGP SIGNATURE-----\n",
      "payload": "tree c9d47ee6b756b34072d1e2744be03ef6f2ca4867\nparent 526dbc99b27419d7051a1d2e62eb645598970054\nauthor Penar Musaraj <pmusaraj@gmail.com> 1622229032 -0400\ncommitter GitHub <noreply@github.com> 1622229032 -0400\n\nFIX: Giphy oneboxing when the response is an image (#13199)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/06e1af2b1d368212df2da9d18a32571b2c30184e",
  "html_url": "https://github.com/discourse/discourse/commit/06e1af2b1d368212df2da9d18a32571b2c30184e",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/06e1af2b1d368212df2da9d18a32571b2c30184e/comments",
  "author": {
    "login": "pmusaraj",
    "id": 368961,
    "node_id": "MDQ6VXNlcjM2ODk2MQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/368961?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pmusaraj",
    "html_url": "https://github.com/pmusaraj",
    "followers_url": "https://api.github.com/users/pmusaraj/followers",
    "following_url": "https://api.github.com/users/pmusaraj/following{/other_user}",
    "gists_url": "https://api.github.com/users/pmusaraj/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pmusaraj/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pmusaraj/subscriptions",
    "organizations_url": "https://api.github.com/users/pmusaraj/orgs",
    "repos_url": "https://api.github.com/users/pmusaraj/repos",
    "events_url": "https://api.github.com/users/pmusaraj/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pmusaraj/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "526dbc99b27419d7051a1d2e62eb645598970054",
      "url": "https://api.github.com/repos/discourse/discourse/commits/526dbc99b27419d7051a1d2e62eb645598970054",
      "html_url": "https://github.com/discourse/discourse/commit/526dbc99b27419d7051a1d2e62eb645598970054"
    }
  ],
  "stats": {
    "total": 16,
    "additions": 15,
    "deletions": 1
  },
  "files": [
    {
      "sha": "9dc8a5f484618a3bc5a4eb90323c760d112cd945",
      "filename": "lib/onebox/engine/animated_image_onebox.rb",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/discourse/discourse/blob/06e1af2b1d368212df2da9d18a32571b2c30184e/lib/onebox/engine/animated_image_onebox.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/06e1af2b1d368212df2da9d18a32571b2c30184e/lib/onebox/engine/animated_image_onebox.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/onebox/engine/animated_image_onebox.rb?ref=06e1af2b1d368212df2da9d18a32571b2c30184e",
      "patch": "@@ -11,7 +11,12 @@ class AnimatedImageOnebox\n \n       def to_html\n         og = get_opengraph\n-        \"<img src='#{og.image}' width='#{og.image_width}' height='#{og.image_height}' class='animated onebox' #{og.title_attr}>\"\n+        if og.image\n+          \"<img src='#{og.image}' width='#{og.image_width}' height='#{og.image_height}' class='animated onebox' #{og.title_attr}>\"\n+        else\n+          escaped_url = ::Onebox::Helpers.normalize_url_for_output(@url)\n+          \"<img src='#{escaped_url}' class='animated onebox'>\"\n+        end\n       end\n     end\n   end"
    },
    {
      "sha": "b5cb9710c366592b29fb6a628a440128eae8c078",
      "filename": "spec/lib/onebox/engine/animated_image_onebox_spec.rb",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/discourse/discourse/blob/06e1af2b1d368212df2da9d18a32571b2c30184e/spec/lib/onebox/engine/animated_image_onebox_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/06e1af2b1d368212df2da9d18a32571b2c30184e/spec/lib/onebox/engine/animated_image_onebox_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/lib/onebox/engine/animated_image_onebox_spec.rb?ref=06e1af2b1d368212df2da9d18a32571b2c30184e",
      "patch": "@@ -4,12 +4,14 @@\n \n describe Onebox::Engine::AnimatedImageOnebox do\n   let(:giphy) { \"http://gph.is/15bRbWf\" }\n+  let(:direct_gif) { \"https://media4.giphy.com/media/Zatyu5LBO2zCyhiAAs/giphy.gif\" }\n   let(:tenor) { \"https://tenor.com/bb3fQ.gif\" }\n \n   before do\n     @previous_options = Onebox.options.to_h\n     Onebox.options = { redirect_limit: 0 }\n     stub_request(:get, giphy).to_return(status: 200, body: onebox_response(\"giphy\"))\n+    stub_request(:get, direct_gif).to_return(status: 200, body: file_from_fixtures(\"animated.webp\"))\n     stub_request(:get, tenor).to_return(status: 200, body: onebox_response(\"tenor\"))\n   end\n \n@@ -23,6 +25,13 @@\n     expect(html).to include(\"class='animated onebox'\")\n   end\n \n+  it \"works when the response is the image asset itself\" do\n+    html = described_class.new(direct_gif).to_html\n+    expect(html).to include(\"img\")\n+    expect(html).to include(\"src='#{direct_gif}'\")\n+    expect(html).to include(\"class='animated onebox'\")\n+  end\n+\n   it \"works for tenor URLs\" do\n     html = described_class.new(tenor).to_html\n     expect(html).to include(\"img\")"
    }
  ]
}
