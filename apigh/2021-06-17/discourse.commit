{
  "sha": "ea2833d0d89df9b48c4fc46e422f3e9b713cac00",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODplYTI4MzNkMGQ4OWRmOWI0OGM0ZmM0NmU0MjJmM2U5YjcxM2NhYzAw",
  "commit": {
    "author": {
      "name": "Bianca Nenciu",
      "email": "nbianca@users.noreply.github.com",
      "date": "2021-06-17T08:53:29Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2021-06-17T08:53:29Z"
    },
    "message": "FIX: Update post's raw from server response (#13414)\n\nThe client used to update the raw, but sometimes the server changed the\r\nraw text, which resulted in false edit conflicts.",
    "tree": {
      "sha": "a0e1cbca0a0d9b47813647340d111768aa887226",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/a0e1cbca0a0d9b47813647340d111768aa887226"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/ea2833d0d89df9b48c4fc46e422f3e9b713cac00",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgyw2JCRBK7hj4Ov3rIwAAuUYIAFtQSNZlvcEd9NtGarfYA5X+\nRuQDVjeMSajemAilzFP1GUKcF9FeGB/gG3MzUq2V7SnBHYm9bNrbWFMl57eF9DDY\nFxjdF68YVlvXzzK0Rir/Szx6xqJOfrDb3KodszszWJPLhMCaE76t37L4xAl90WSm\nvVEqDlb0m6k733ujVffhLxOQDGidE6IQEi90kJtaFen9GpGpLbwQjHz32VJsIlW8\nUSFOIz+SWcHFRQU2VF1Rn9MUmuSjs6ruaNum6Er4Nujy3xznO94fVGardJNOoXdC\n79uZ3z1QCFy3kYzPKnUEU9xu7UV83xmJJbuicMOoE0Lj4aw/in+P43LVdOcLOUg=\n=1Z+h\n-----END PGP SIGNATURE-----\n",
      "payload": "tree a0e1cbca0a0d9b47813647340d111768aa887226\nparent 90bd88627a6b56d6a3f421030050f309cfbc40a1\nauthor Bianca Nenciu <nbianca@users.noreply.github.com> 1623920009 +0300\ncommitter GitHub <noreply@github.com> 1623920009 +0300\n\nFIX: Update post's raw from server response (#13414)\n\nThe client used to update the raw, but sometimes the server changed the\r\nraw text, which resulted in false edit conflicts."
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/ea2833d0d89df9b48c4fc46e422f3e9b713cac00",
  "html_url": "https://github.com/discourse/discourse/commit/ea2833d0d89df9b48c4fc46e422f3e9b713cac00",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/ea2833d0d89df9b48c4fc46e422f3e9b713cac00/comments",
  "author": {
    "login": "nbianca",
    "id": 23153890,
    "node_id": "MDQ6VXNlcjIzMTUzODkw",
    "avatar_url": "https://avatars.githubusercontent.com/u/23153890?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nbianca",
    "html_url": "https://github.com/nbianca",
    "followers_url": "https://api.github.com/users/nbianca/followers",
    "following_url": "https://api.github.com/users/nbianca/following{/other_user}",
    "gists_url": "https://api.github.com/users/nbianca/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nbianca/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nbianca/subscriptions",
    "organizations_url": "https://api.github.com/users/nbianca/orgs",
    "repos_url": "https://api.github.com/users/nbianca/repos",
    "events_url": "https://api.github.com/users/nbianca/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nbianca/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "90bd88627a6b56d6a3f421030050f309cfbc40a1",
      "url": "https://api.github.com/repos/discourse/discourse/commits/90bd88627a6b56d6a3f421030050f309cfbc40a1",
      "html_url": "https://github.com/discourse/discourse/commit/90bd88627a6b56d6a3f421030050f309cfbc40a1"
    }
  ],
  "stats": {
    "total": 12,
    "additions": 6,
    "deletions": 6
  },
  "files": [
    {
      "sha": "36349ed1210e1383650facdbca71f8ed69fe4690",
      "filename": "app/assets/javascripts/discourse/app/models/composer.js",
      "status": "modified",
      "additions": 2,
      "deletions": 3,
      "changes": 5,
      "blob_url": "https://github.com/discourse/discourse/blob/ea2833d0d89df9b48c4fc46e422f3e9b713cac00/app/assets/javascripts/discourse/app/models/composer.js",
      "raw_url": "https://github.com/discourse/discourse/raw/ea2833d0d89df9b48c4fc46e422f3e9b713cac00/app/assets/javascripts/discourse/app/models/composer.js",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/discourse/app/models/composer.js?ref=ea2833d0d89df9b48c4fc46e422f3e9b713cac00",
      "patch": "@@ -929,7 +929,6 @@ const Composer = RestModel.extend({\n \n   editPost(opts) {\n     const post = this.post;\n-    const oldRaw = post.raw;\n     const oldCooked = post.cooked;\n     let promise = Promise.resolve();\n \n@@ -971,14 +970,14 @@ const Composer = RestModel.extend({\n     this.set(\"composeState\", SAVING);\n \n     const rollback = throwAjaxError((error) => {\n-      post.setProperties({ raw: oldRaw, cooked: oldCooked });\n+      post.setProperties(\"cooked\", oldCooked);\n       this.set(\"composeState\", OPEN);\n       if (error.jqXHR && error.jqXHR.status === 409) {\n         this.set(\"editConflict\", true);\n       }\n     });\n \n-    post.setProperties({ raw: props.raw, cooked: props.cooked, staged: true });\n+    post.setProperties({ cooked: props.cooked, staged: true });\n     this.appEvents.trigger(\"post-stream:refresh\", { id: post.id });\n \n     return promise"
    },
    {
      "sha": "c59a97b71c4205ad87105fbf3d76a7f14673b6e2",
      "filename": "app/controllers/posts_controller.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/ea2833d0d89df9b48c4fc46e422f3e9b713cac00/app/controllers/posts_controller.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/ea2833d0d89df9b48c4fc46e422f3e9b713cac00/app/controllers/posts_controller.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/controllers/posts_controller.rb?ref=ea2833d0d89df9b48c4fc46e422f3e9b713cac00",
      "patch": "@@ -247,7 +247,7 @@ def update\n     return render_json_error(post) if post.errors.present?\n     return render_json_error(topic) if topic.errors.present?\n \n-    post_serializer = PostSerializer.new(post, scope: guardian, root: false)\n+    post_serializer = PostSerializer.new(post, scope: guardian, root: false, add_raw: true)\n     post_serializer.draft_sequence = DraftSequence.current(current_user, topic.draft_key)\n     link_counts = TopicLink.counts_for(guardian, topic, [post])\n     post_serializer.single_post_link_counts = link_counts[post.id] if link_counts.present?"
    },
    {
      "sha": "a149ed697fcf172dba3c7e963de8612d75f792e5",
      "filename": "spec/requests/posts_controller_spec.rb",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/discourse/discourse/blob/ea2833d0d89df9b48c4fc46e422f3e9b713cac00/spec/requests/posts_controller_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/ea2833d0d89df9b48c4fc46e422f3e9b713cac00/spec/requests/posts_controller_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/requests/posts_controller_spec.rb?ref=ea2833d0d89df9b48c4fc46e422f3e9b713cac00",
      "patch": "@@ -415,10 +415,11 @@\n       end\n \n       it \"updates post's raw attribute\" do\n-        put \"/posts/#{post.id}.json\", params: update_params\n+        put \"/posts/#{post.id}.json\", params: { post: { raw: 'edited body   ' } }\n \n         expect(response.status).to eq(200)\n-        expect(post.reload.raw).to eq(update_params[:post][:raw])\n+        expect(response.parsed_body['post']['raw']).to eq('edited body')\n+        expect(post.reload.raw).to eq('edited body')\n       end\n \n       it \"extracts links from the new body\" do"
    }
  ]
}
