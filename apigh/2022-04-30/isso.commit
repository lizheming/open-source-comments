{
  "sha": "0a93ac54aa2c684f1e2bcda5410720651993ac53",
  "node_id": "C_kwDOAF-mA9oAKDBhOTNhYzU0YWEyYzY4NGYxZTJiY2RhNTQxMDcyMDY1MTk5M2FjNTM",
  "commit": {
    "author": {
      "name": "ix5",
      "email": "ix5@users.noreply.github.com",
      "date": "2022-04-29T19:27:33Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2022-04-29T19:27:33Z"
    },
    "message": "Merge pull request #847 from ix5/docker-e2e\n\n[ci] [docker] Use docker for e2e, client testing, add docker-compose file",
    "tree": {
      "sha": "dce0492e9549b0bab0b86d257baf776cb5fab0da",
      "url": "https://api.github.com/repos/posativ/isso/git/trees/dce0492e9549b0bab0b86d257baf776cb5fab0da"
    },
    "url": "https://api.github.com/repos/posativ/isso/git/commits/0a93ac54aa2c684f1e2bcda5410720651993ac53",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJibDwlCRBK7hj4Ov3rIwAAccYIAK6a05djS4oYLYtkkleHf3di\nGWL2s28LdLECK3FYmCaziG7HDiObl7UuZMzcCA2X4BM2Bjk6QSkJZKoEN59QMlWX\n71pAOoOgqcOg/xK6BP+YMzc76JFsYRSbFr9V78u0B0rLVsaMm6C1AHnF2z+PgSSZ\ne5z9Zfc+Bg2H4YapDp8p5asbPuYzRpJFF+gm4D6w2GqHlfhJhB2Vi+W0EL9OSFZ7\nBIt8MWOKQj3FxwTdAL8/kFcE5ROXCsH7TyRrb4QM6I8csTV28bFhIytMHXzDK+Pn\ndDn8cQGl0UnX/RWbUrKDW6rNATQa1fB2AIGD++MDJ0qYUwXk77ENty/wcx6eRp8=\n=BEDg\n-----END PGP SIGNATURE-----\n",
      "payload": "tree dce0492e9549b0bab0b86d257baf776cb5fab0da\nparent aaa9de1135104f279107e32661c9bb5ff3092e38\nparent 3c5d6379a364c78271a1817587cf8a936c0acbd4\nauthor ix5 <ix5@users.noreply.github.com> 1651260453 +0200\ncommitter GitHub <noreply@github.com> 1651260453 +0200\n\nMerge pull request #847 from ix5/docker-e2e\n\n[ci] [docker] Use docker for e2e, client testing, add docker-compose file"
    }
  },
  "url": "https://api.github.com/repos/posativ/isso/commits/0a93ac54aa2c684f1e2bcda5410720651993ac53",
  "html_url": "https://github.com/posativ/isso/commit/0a93ac54aa2c684f1e2bcda5410720651993ac53",
  "comments_url": "https://api.github.com/repos/posativ/isso/commits/0a93ac54aa2c684f1e2bcda5410720651993ac53/comments",
  "author": {
    "login": "ix5",
    "id": 10212877,
    "node_id": "MDQ6VXNlcjEwMjEyODc3",
    "avatar_url": "https://avatars.githubusercontent.com/u/10212877?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ix5",
    "html_url": "https://github.com/ix5",
    "followers_url": "https://api.github.com/users/ix5/followers",
    "following_url": "https://api.github.com/users/ix5/following{/other_user}",
    "gists_url": "https://api.github.com/users/ix5/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ix5/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ix5/subscriptions",
    "organizations_url": "https://api.github.com/users/ix5/orgs",
    "repos_url": "https://api.github.com/users/ix5/repos",
    "events_url": "https://api.github.com/users/ix5/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ix5/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "aaa9de1135104f279107e32661c9bb5ff3092e38",
      "url": "https://api.github.com/repos/posativ/isso/commits/aaa9de1135104f279107e32661c9bb5ff3092e38",
      "html_url": "https://github.com/posativ/isso/commit/aaa9de1135104f279107e32661c9bb5ff3092e38"
    },
    {
      "sha": "3c5d6379a364c78271a1817587cf8a936c0acbd4",
      "url": "https://api.github.com/repos/posativ/isso/commits/3c5d6379a364c78271a1817587cf8a936c0acbd4",
      "html_url": "https://github.com/posativ/isso/commit/3c5d6379a364c78271a1817587cf8a936c0acbd4"
    }
  ],
  "stats": {
    "total": 172,
    "additions": 172,
    "deletions": 0
  },
  "files": [
    {
      "sha": "2f466f03ca5063eb70cee42cdde9fb9268097e47",
      "filename": ".dockerignore",
      "status": "added",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/posativ/isso/blob/0a93ac54aa2c684f1e2bcda5410720651993ac53/.dockerignore",
      "raw_url": "https://github.com/posativ/isso/raw/0a93ac54aa2c684f1e2bcda5410720651993ac53/.dockerignore",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/.dockerignore?ref=0a93ac54aa2c684f1e2bcda5410720651993ac53",
      "patch": "@@ -0,0 +1,4 @@\n+# Files that should not be sent to the docker daemon when building\n+# Docker will have its own cache of node packages and its own python venv\n+node_modules/\n+.venv/"
    },
    {
      "sha": "31c812a2ca0a8b2393b68bd4eaead863f60a6e7f",
      "filename": ".github/workflows/docker-compose.yml",
      "status": "added",
      "additions": 36,
      "deletions": 0,
      "changes": 36,
      "blob_url": "https://github.com/posativ/isso/blob/0a93ac54aa2c684f1e2bcda5410720651993ac53/.github%2Fworkflows%2Fdocker-compose.yml",
      "raw_url": "https://github.com/posativ/isso/raw/0a93ac54aa2c684f1e2bcda5410720651993ac53/.github%2Fworkflows%2Fdocker-compose.yml",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/.github%2Fworkflows%2Fdocker-compose.yml?ref=0a93ac54aa2c684f1e2bcda5410720651993ac53",
      "patch": "@@ -0,0 +1,36 @@\n+name: E2e tests with docker\n+\n+on:\n+  - push\n+  - pull_request\n+\n+jobs:\n+  test:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+\n+      - name: Build the stack\n+        run: |\n+          docker compose build isso-js-puppeteer-intermediary\n+          docker compose build isso-server\n+          docker compose build isso-client\n+\n+      - name: Bring up containers\n+        run: docker compose up -d\n+\n+      - name: Client unit tests\n+        run: |\n+          docker run \\\n+          --mount type=bind,source=${{ github.workspace }}/package.json,target=/src/package.json,readonly \\\n+          --mount type=bind,source=${{ github.workspace }}/isso/js/,target=/src/isso/js/,readonly \\\n+          isso-js-testbed npm run test-unit\n+\n+      - name: Client integration tests\n+        run: |\n+          docker run \\\n+          --mount type=bind,source=${{ github.workspace }}/package.json,target=/src/package.json,readonly \\\n+          --mount type=bind,source=${{ github.workspace }}/isso/js/,target=/src/isso/js/,readonly \\\n+          --env ISSO_ENDPOINT='http://isso-dev.local:8080' \\\n+          --network container:isso-server \\\n+          isso-js-testbed npm run test-integration"
    },
    {
      "sha": "b828b4ad60725b404a986f463f6dfa1af02b2ad9",
      "filename": "docker-compose.yml",
      "status": "added",
      "additions": 77,
      "deletions": 0,
      "changes": 77,
      "blob_url": "https://github.com/posativ/isso/blob/0a93ac54aa2c684f1e2bcda5410720651993ac53/docker-compose.yml",
      "raw_url": "https://github.com/posativ/isso/raw/0a93ac54aa2c684f1e2bcda5410720651993ac53/docker-compose.yml",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/docker-compose.yml?ref=0a93ac54aa2c684f1e2bcda5410720651993ac53",
      "patch": "@@ -0,0 +1,77 @@\n+# https://docs.docker.com/compose/compose-file/compose-file-v3/\n+version: \"3.9\"\n+\n+services:\n+\n+  # Force building intermediate image\n+  isso-js-puppeteer-intermediary:\n+    image: isso-js-puppeteer\n+    container_name: isso-js-puppeteer-intermediary\n+    build:\n+      context: .\n+      dockerfile: docker/Dockerfile-js-puppeteer\n+\n+  # Isso server should always reflect production image\n+  isso-server:\n+    image: isso\n+    container_name: isso-server\n+    build:\n+      context: .\n+      dockerfile: Dockerfile\n+    # No need to set entrypoint, image already provides CMD\n+    #command: /isso/bin/isso -c /config/isso.cfg run\n+    environment:\n+      ISSO_SETTINGS: \"/config/isso-dev.cfg\"\n+    # If needed, production docker image can also be exposed for non-docker\n+    # unit/integration testing\n+    #ports:\n+    #  - 127.0.0.1:8080:8080\n+    expose:\n+      - 8080\n+    networks:\n+      test-net:\n+        # Also make available under http://isso-dev.local and localhost:\n+        aliases:\n+        - isso-dev.local\n+        - localhost\n+    volumes:\n+      - ./db:/db/\n+      - type: bind\n+        source: ./share/isso-dev.cfg\n+        target: /config/isso-dev.cfg\n+        volume:\n+          nocopy: true\n+\n+  # Jest and puppeteer end-to-end integration test runner\n+  isso-client:\n+    image: isso-js-testbed\n+    container_name: isso-client\n+    build:\n+      context: .\n+      dockerfile: docker/Dockerfile-js-testbed\n+    environment:\n+      ISSO_ENDPOINT: \"http://isso-dev.local:8080\"\n+    # Command may also run from outside docker compose, e.g.:\n+    # $ docker run isso-js-testbed [mount, networks, ...] npm run test-integration\n+    #command: npm run test-integration\n+    networks:\n+      - test-net\n+    # Bind-mounts, see:\n+    # https://docs.docker.com/compose/compose-file/compose-file-v3/#long-syntax-3\n+    volumes:\n+      - type: bind\n+        source: ./package.json\n+        target: /src/package.json\n+        volume:\n+          nocopy: true\n+      - type: bind\n+        source: ./isso/js/\n+        target: /src/isso/js/\n+        volume:\n+          nocopy: true\n+    depends_on:\n+      - isso-server\n+      - isso-js-puppeteer-intermediary\n+\n+networks:\n+  test-net:"
    },
    {
      "sha": "d021554bd33d831e8a08f62b9d7131e9842c8a0a",
      "filename": "docker/Dockerfile-js-puppeteer",
      "status": "added",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/posativ/isso/blob/0a93ac54aa2c684f1e2bcda5410720651993ac53/docker%2FDockerfile-js-puppeteer",
      "raw_url": "https://github.com/posativ/isso/raw/0a93ac54aa2c684f1e2bcda5410720651993ac53/docker%2FDockerfile-js-puppeteer",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/docker%2FDockerfile-js-puppeteer?ref=0a93ac54aa2c684f1e2bcda5410720651993ac53",
      "patch": "@@ -0,0 +1,19 @@\n+# Download puppeteer assets\n+# This image should be tagged as \"isso-js-puppeteer\"\n+\n+# Avoid triggering a re-download of its puppeteer assets if at all possible\n+\n+# Note: Keep (alpine) base image in sync with other dockerfiles to avoid\n+# duplication\n+FROM docker.io/node:current AS isso-js-puppeteer\n+WORKDIR /src/\n+\n+# Installing puppeteer will take some time as it pulls in\n+# a ~400Mb headless chrome file\n+RUN npm install puppeteer\n+\n+# Example of use:\n+#\n+# docker build -f docker/Dockerfile-js-puppeteer -t isso-js-puppeteer .\n+\n+# vim: set filetype=dockerfile"
    },
    {
      "sha": "d6ea877eaa6f3e3f2ca32bc20b511b47041fc147",
      "filename": "docker/Dockerfile-js-testbed",
      "status": "added",
      "additions": 36,
      "deletions": 0,
      "changes": 36,
      "blob_url": "https://github.com/posativ/isso/blob/0a93ac54aa2c684f1e2bcda5410720651993ac53/docker%2FDockerfile-js-testbed",
      "raw_url": "https://github.com/posativ/isso/raw/0a93ac54aa2c684f1e2bcda5410720651993ac53/docker%2FDockerfile-js-testbed",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/docker%2FDockerfile-js-testbed?ref=0a93ac54aa2c684f1e2bcda5410720651993ac53",
      "patch": "@@ -0,0 +1,36 @@\n+# Prepare a testbed for Javascript testing\n+# This image should be tagged as \"isso-js-testbed\"\n+\n+# Note: Do not use alpine images as they do not contain needed GObject, X11\n+# etc. packages and complicate things\n+# :current resolves to NodeJS 17 on Debian Buster as of 03/2022\n+# https://hub.docker.com/_/node\n+FROM docker.io/node:current AS isso-js-testbed\n+WORKDIR /src/\n+\n+# Install everything necessary to run headless\n+RUN apt-get update && apt-get install -y --no-install-recommends libnss3 libxss1 chromium\n+\n+# Skip downloading headless chromium\n+ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD true\n+\n+RUN npm install --no-save jest jest-puppeteer jest-environment-jsdom\n+\n+# Restore headless chromium files from intermediate image\n+COPY --from=isso-js-puppeteer \\\n+    /src/node_modules/puppeteer/.local-chromium/ \\\n+    ./node_modules/puppeteer/.local-chromium/\n+\n+# Need to set $CI so that jest-puppeteer applies sensible launch params for\n+# running headless chromium. Otherwise, chromium will fail with a \"missing\n+# sandbox\" error.\n+# https://github.com/smooth-code/jest-puppeteer/blob/678ce56b49100f248237757df19f89b2542a9465/packages/jest-environment-puppeteer/src/readConfig.js#L14-L28\n+ENV CI=true\n+\n+# Note: No entry point, will be set by docker-compose\n+\n+# Example of use:\n+#\n+# docker build -f docker/Dockerfile-js-testbed -t isso-js-testbed .\n+\n+# vim: set filetype=dockerfile"
    }
  ]
}
