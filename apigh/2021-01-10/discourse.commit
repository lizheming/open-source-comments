{
  "sha": "b0088361a474575a4fcd3fbef77d9fa0286ef113",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODpiMDA4ODM2MWE0NzQ1NzVhNGZjZDNmYmVmNzdkOWZhMDI4NmVmMTEz",
  "commit": {
    "author": {
      "name": "David Taylor",
      "email": "david@taylorhq.com",
      "date": "2021-01-09T13:52:53Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2021-01-09T13:52:53Z"
    },
    "message": "FIX: Do not include URL query in auto-generated CSP header (#11673)",
    "tree": {
      "sha": "45dc025fe2274c683739529d7f1c3fe610bf2331",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/45dc025fe2274c683739529d7f1c3fe610bf2331"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/b0088361a474575a4fcd3fbef77d9fa0286ef113",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf+bU1CRBK7hj4Ov3rIwAAdHIIADzDWF6wdGNzNMbGdX1mvkbn\nqVrDj6y+rBBPPQkqRyEydd0pnq4PfNO1KXd61eGTxbhAiXe9nShqBMr7SOo5fqTD\ndiR2YlzC179ihzvrs4tMbjNTIObaxwQgnT8YUth6RgTV0xvsGQ6xEzYstd5lUDM/\nYxW82wsvER0ZWS3SzDM1DGGiiidI2yUc26I1cjRujuerwjeSKVEImB18mQNJau5P\nSGPzxOkCvqLTgNnp6oarXNljsOMnPuP68eEZ4N6WlvhlMDAsV8GZ7P4vBQd3aa98\nEUVAi2STXGcpSn7HzlHqMxSn/0lYv58GQiIlYKf9SQz2gh4ZG+eizwia6whVSKE=\n=r7LN\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 45dc025fe2274c683739529d7f1c3fe610bf2331\nparent 9da9b2e1cc314c8c2633303e17eb0d215757d58d\nauthor David Taylor <david@taylorhq.com> 1610200373 +0000\ncommitter GitHub <noreply@github.com> 1610200373 +0000\n\nFIX: Do not include URL query in auto-generated CSP header (#11673)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/b0088361a474575a4fcd3fbef77d9fa0286ef113",
  "html_url": "https://github.com/discourse/discourse/commit/b0088361a474575a4fcd3fbef77d9fa0286ef113",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/b0088361a474575a4fcd3fbef77d9fa0286ef113/comments",
  "author": {
    "login": "davidtaylorhq",
    "id": 6270921,
    "node_id": "MDQ6VXNlcjYyNzA5MjE=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/6270921?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/davidtaylorhq",
    "html_url": "https://github.com/davidtaylorhq",
    "followers_url": "https://api.github.com/users/davidtaylorhq/followers",
    "following_url": "https://api.github.com/users/davidtaylorhq/following{/other_user}",
    "gists_url": "https://api.github.com/users/davidtaylorhq/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/davidtaylorhq/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/davidtaylorhq/subscriptions",
    "organizations_url": "https://api.github.com/users/davidtaylorhq/orgs",
    "repos_url": "https://api.github.com/users/davidtaylorhq/repos",
    "events_url": "https://api.github.com/users/davidtaylorhq/events{/privacy}",
    "received_events_url": "https://api.github.com/users/davidtaylorhq/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "9da9b2e1cc314c8c2633303e17eb0d215757d58d",
      "url": "https://api.github.com/repos/discourse/discourse/commits/9da9b2e1cc314c8c2633303e17eb0d215757d58d",
      "html_url": "https://github.com/discourse/discourse/commit/9da9b2e1cc314c8c2633303e17eb0d215757d58d"
    }
  ],
  "stats": {
    "total": 5,
    "additions": 5,
    "deletions": 0
  },
  "files": [
    {
      "sha": "c697f5186bb21724b1fb2243054dd46b3056ae15",
      "filename": "lib/content_security_policy/extension.rb",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/b0088361a474575a4fcd3fbef77d9fa0286ef113/lib/content_security_policy/extension.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/b0088361a474575a4fcd3fbef77d9fa0286ef113/lib/content_security_policy/extension.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/content_security_policy/extension.rb?ref=b0088361a474575a4fcd3fbef77d9fa0286ef113",
      "patch": "@@ -70,6 +70,8 @@ def find_theme_extensions(theme_ids)\n         next if uri.host.nil? # Ignore same-domain scripts (theme-javascripts)\n         next if uri.path.nil? # Ignore raw hosts\n \n+        uri.query = nil # CSP should not include query part of url\n+\n         uri_string = uri.to_s.sub(/^\\/\\//, '') # Protocol-less CSP should not have // at beginning of URL\n \n         auto_script_src_extension[:script_src] << uri_string"
    },
    {
      "sha": "f4a73c6bbc9a527e8fe2c89c02bc50c9c7e9d868",
      "filename": "spec/lib/content_security_policy_spec.rb",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/discourse/discourse/blob/b0088361a474575a4fcd3fbef77d9fa0286ef113/spec/lib/content_security_policy_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/b0088361a474575a4fcd3fbef77d9fa0286ef113/spec/lib/content_security_policy_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/lib/content_security_policy_spec.rb?ref=b0088361a474575a4fcd3fbef77d9fa0286ef113",
      "patch": "@@ -239,6 +239,7 @@ def theme_policy\n \n       theme.set_field(target: :common, name: \"header\", value: <<~SCRIPT)\n         <script src='https://example.com/myscript.js'></script>\n+        <script src='https://example.com/myscript2.js?with=query'></script>\n         <script src='//example2.com/protocol-less-script.js'></script>\n         <script src='domain-only.com'></script>\n         <script>console.log('inline script')</script>\n@@ -248,6 +249,8 @@ def theme_policy\n       theme.save!\n \n       expect(parse(theme_policy)['script-src']).to include('https://example.com/myscript.js')\n+      expect(parse(theme_policy)['script-src']).to include('https://example.com/myscript2.js')\n+      expect(parse(theme_policy)['script-src']).not_to include('?')\n       expect(parse(theme_policy)['script-src']).to include('example2.com/protocol-less-script.js')\n       expect(parse(theme_policy)['script-src']).not_to include('domain-only.com')\n       expect(parse(theme_policy)['script-src']).not_to include(a_string_matching /^\\/theme-javascripts/)"
    }
  ]
}
