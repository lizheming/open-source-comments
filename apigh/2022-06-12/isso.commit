{
  "sha": "30ef2180f70ebd58b929673e27d73d889442eb99",
  "node_id": "C_kwDOAF-mA9oAKDMwZWYyMTgwZjcwZWJkNThiOTI5NjczZTI3ZDczZDg4OTQ0MmViOTk",
  "commit": {
    "author": {
      "name": "ix5",
      "email": "ix5@users.noreply.github.com",
      "date": "2022-06-12T10:46:19Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2022-06-12T10:46:19Z"
    },
    "message": "Merge pull request #903 from projectgus/bugfix/migrate_wordpress_paragraphs\n\nmigrate: Handle single newlines in WordPress comments as line breaks",
    "tree": {
      "sha": "fec48506030ce2573fe0100586f9a9ad1b5ba625",
      "url": "https://api.github.com/repos/posativ/isso/git/trees/fec48506030ce2573fe0100586f9a9ad1b5ba625"
    },
    "url": "https://api.github.com/repos/posativ/isso/git/commits/30ef2180f70ebd58b929673e27d73d889442eb99",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJipcP7CRBK7hj4Ov3rIwAAc/AIAEqdFoM2ZUqicQ/KlWwS+8t2\n59D0oStH12s7444vn+CYnjkbLy2C1dYLGafnLr+CDYPGTobdz+NEkZSdWBWcsT7J\nKkVbQVFijcqOXiRZJG3+COqYMgkbQB7qSgSXKDcn4ztPwUBPEHegDsotDfUedWQc\nsZQNxhjpUEH9UMLO4MmfkE5LS51t2ukSI9oec0/IVU+W9Y08gdUcpFm/XcG3awqs\nnVAYhtye2o7xNzYTpENcXGvCly7ren2kd+2Mk9A3M/xs5N1Es5bvf0MsqgU8pCvs\nmRJlzs81J+xXD6J2fYIOSEmX9p2OJ9dkbayotvKaWnvvMLzxanWe0gT4Wu3s+zs=\n=7Vml\n-----END PGP SIGNATURE-----\n",
      "payload": "tree fec48506030ce2573fe0100586f9a9ad1b5ba625\nparent b1021d1e57dd595a581a614ecd26edea4ae69557\nparent 0cf4c17ab66aa24904da9b461d384c602c229a1d\nauthor ix5 <ix5@users.noreply.github.com> 1655030779 +0200\ncommitter GitHub <noreply@github.com> 1655030779 +0200\n\nMerge pull request #903 from projectgus/bugfix/migrate_wordpress_paragraphs\n\nmigrate: Handle single newlines in WordPress comments as line breaks"
    }
  },
  "url": "https://api.github.com/repos/posativ/isso/commits/30ef2180f70ebd58b929673e27d73d889442eb99",
  "html_url": "https://github.com/posativ/isso/commit/30ef2180f70ebd58b929673e27d73d889442eb99",
  "comments_url": "https://api.github.com/repos/posativ/isso/commits/30ef2180f70ebd58b929673e27d73d889442eb99/comments",
  "author": {
    "login": "ix5",
    "id": 10212877,
    "node_id": "MDQ6VXNlcjEwMjEyODc3",
    "avatar_url": "https://avatars.githubusercontent.com/u/10212877?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ix5",
    "html_url": "https://github.com/ix5",
    "followers_url": "https://api.github.com/users/ix5/followers",
    "following_url": "https://api.github.com/users/ix5/following{/other_user}",
    "gists_url": "https://api.github.com/users/ix5/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ix5/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ix5/subscriptions",
    "organizations_url": "https://api.github.com/users/ix5/orgs",
    "repos_url": "https://api.github.com/users/ix5/repos",
    "events_url": "https://api.github.com/users/ix5/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ix5/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "b1021d1e57dd595a581a614ecd26edea4ae69557",
      "url": "https://api.github.com/repos/posativ/isso/commits/b1021d1e57dd595a581a614ecd26edea4ae69557",
      "html_url": "https://github.com/posativ/isso/commit/b1021d1e57dd595a581a614ecd26edea4ae69557"
    },
    {
      "sha": "0cf4c17ab66aa24904da9b461d384c602c229a1d",
      "url": "https://api.github.com/repos/posativ/isso/commits/0cf4c17ab66aa24904da9b461d384c602c229a1d",
      "html_url": "https://github.com/posativ/isso/commit/0cf4c17ab66aa24904da9b461d384c602c229a1d"
    }
  ],
  "stats": {
    "total": 43,
    "additions": 37,
    "deletions": 6
  },
  "files": [
    {
      "sha": "f036a6379ae932077d3db72998ec5e817b2e3de6",
      "filename": "CHANGES.rst",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/posativ/isso/blob/30ef2180f70ebd58b929673e27d73d889442eb99/CHANGES.rst",
      "raw_url": "https://github.com/posativ/isso/raw/30ef2180f70ebd58b929673e27d73d889442eb99/CHANGES.rst",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/CHANGES.rst?ref=30ef2180f70ebd58b929673e27d73d889442eb99",
      "patch": "@@ -17,8 +17,10 @@ Breaking Changes\n Bugfixes & Improvements\n ^^^^^^^^^^^^^^^^^^^^^^^\n \n-- TBD\n+- When importing from WordPress single newlines are now converted to line breaks\n+  (`#903`_, projectgus)\n \n+.. _#903: https://github.com/posativ/isso/pull/903\n \n 0.13.0.beta1 (2022-06-05)\n -------------------------"
    },
    {
      "sha": "b8e0c2484da4045378c8df631dde9e97ae99b811",
      "filename": "isso/migrate.py",
      "status": "modified",
      "additions": 10,
      "deletions": 1,
      "changes": 11,
      "blob_url": "https://github.com/posativ/isso/blob/30ef2180f70ebd58b929673e27d73d889442eb99/isso%2Fmigrate.py",
      "raw_url": "https://github.com/posativ/isso/raw/30ef2180f70ebd58b929673e27d73d889442eb99/isso%2Fmigrate.py",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/isso%2Fmigrate.py?ref=30ef2180f70ebd58b929673e27d73d889442eb99",
      "patch": "@@ -225,9 +225,18 @@ def migrate(self):\n         progress.finish(\"{0} threads, {1} comments\".format(\n             len(items) - skip, self.count))\n \n+    def _process_comment_content(self, text):\n+        # WordPress comment text renders a single newline between two blocks of\n+        # text as a <br> tag, so add an explicit Markdown line break on import\n+        # (Otherwise multiple blocks of text separated by single newlines are\n+        # all shown as one long line.)\n+        text = re.sub(r'(?!^\\n)\\n(?!^\\n)', '  \\n', text, 0)\n+\n+        return strip(text)\n+\n     def Comment(self, el):\n         return {\n-            \"text\": strip(el.find(self.ns + \"comment_content\").text),\n+            \"text\": self._process_comment_content(el.find(self.ns + \"comment_content\").text),\n             \"author\": strip(el.find(self.ns + \"comment_author\").text),\n             \"email\": strip(el.find(self.ns + \"comment_author_email\").text),\n             \"website\": strip(el.find(self.ns + \"comment_author_url\").text),"
    },
    {
      "sha": "ff5f55f05226c22fc0e7495406cb2a8f1b4929c8",
      "filename": "isso/tests/test_migration.py",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "blob_url": "https://github.com/posativ/isso/blob/30ef2180f70ebd58b929673e27d73d889442eb99/isso%2Ftests%2Ftest_migration.py",
      "raw_url": "https://github.com/posativ/isso/raw/30ef2180f70ebd58b929673e27d73d889442eb99/isso%2Ftests%2Ftest_migration.py",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/isso%2Ftests%2Ftest_migration.py?ref=30ef2180f70ebd58b929673e27d73d889442eb99",
      "patch": "@@ -87,7 +87,7 @@ def test_wordpress(self):\n         self.assertEqual(\n             len(db.execute(\"SELECT id FROM threads\").fetchall()), 2)\n         self.assertEqual(\n-            len(db.execute(\"SELECT id FROM comments\").fetchall()), 7)\n+            len(db.execute(\"SELECT id FROM comments\").fetchall()), 8)\n \n         first = db.comments.get(1)\n         self.assertEqual(first[\"author\"], \"Ohai\")\n@@ -101,7 +101,11 @@ def test_wordpress(self):\n         for i in (3, 4, 5):\n             self.assertEqual(db.comments.get(i)[\"parent\"], second[\"id\"])\n \n-        last = db.comments.get(6)\n+        # Ensure newlines in wordpress translate to two newlines in isso, to render the same\n+        multiline = db.comments.get(6)\n+        self.assertIn(\"multiple lines:  \\nWordPress\", multiline[\"text\"])\n+\n+        last = db.comments.get(7)\n         self.assertEqual(last[\"author\"], \"Letzter :/\")\n         self.assertEqual(last[\"parent\"], None)\n "
    },
    {
      "sha": "53beb6c20198c7cb4ce4768d84800e4046454251",
      "filename": "isso/tests/wordpress.xml",
      "status": "modified",
      "additions": 18,
      "deletions": 2,
      "changes": 20,
      "blob_url": "https://github.com/posativ/isso/blob/30ef2180f70ebd58b929673e27d73d889442eb99/isso%2Ftests%2Fwordpress.xml",
      "raw_url": "https://github.com/posativ/isso/raw/30ef2180f70ebd58b929673e27d73d889442eb99/isso%2Ftests%2Fwordpress.xml",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/isso%2Ftests%2Fwordpress.xml?ref=30ef2180f70ebd58b929673e27d73d889442eb99",
      "patch": "@@ -101,13 +101,29 @@\n             </wp:comment>\n             <wp:comment>\n                 <wp:comment_id>10</wp:comment_id>\n+                <wp:comment_author><![CDATA[Multiline Author]]></wp:comment_author>\n+                <wp:comment_author_email>multiline@example.org\n+                </wp:comment_author_email>\n+                <wp:comment_author_url></wp:comment_author_url>\n+                <wp:comment_author_IP>::ffff:86.52.1.0</wp:comment_author_IP>\n+                <wp:comment_date>2022-06-06 12:13:14</wp:comment_date>\n+                <wp:comment_date_gmt>2022-06-06 02:13:14</wp:comment_date_gmt>\n+                <wp:comment_content><![CDATA[When you have a comment with multiple lines:\n+WordPress exports it like this.]]></wp:comment_content>\n+                <wp:comment_approved>1</wp:comment_approved>\n+                <wp:comment_type></wp:comment_type>\n+                <wp:comment_parent>0</wp:comment_parent>\n+                <wp:comment_user_id>1</wp:comment_user_id>\n+            </wp:comment>\n+            <wp:comment>\n+                <wp:comment_id>11</wp:comment_id>\n                 <wp:comment_author><![CDATA[Letzter :/]]></wp:comment_author>\n                 <wp:comment_author_email>info@posativ.org\n                 </wp:comment_author_email>\n                 <wp:comment_author_url></wp:comment_author_url>\n                 <wp:comment_author_IP>::ffff:86.56.63.0</wp:comment_author_IP>\n-                <wp:comment_date>2014-04-29 15:21:56</wp:comment_date>\n-                <wp:comment_date_gmt>2014-04-29 15:21:56</wp:comment_date_gmt>\n+                <wp:comment_date>2022-06-07 15:21:56</wp:comment_date>\n+                <wp:comment_date_gmt>2022-06-07 15:21:56</wp:comment_date_gmt>\n                 <wp:comment_content><![CDATA[...]]></wp:comment_content>\n                 <wp:comment_approved>1</wp:comment_approved>\n                 <wp:comment_type></wp:comment_type>"
    }
  ]
}
