{
  "sha": "69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo2OWY4YzNiMzA1N2RiZjcwZmYyYjMzYWIzNTRlZWExOGU3ZDJkN2Iz",
  "commit": {
    "author": {
      "name": "Joffrey JAFFEUX",
      "email": "j.jaffeux@gmail.com",
      "date": "2021-04-20T11:28:59Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2021-04-20T11:28:59Z"
    },
    "message": "UX: displays a descriptive error when theme is not allowed (#12763)",
    "tree": {
      "sha": "c726d2e658240ea8079e31103d5b7984fe890e6b",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/c726d2e658240ea8079e31103d5b7984fe890e6b"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgfrr7CRBK7hj4Ov3rIwAAUxgIADPYsP9lf/1Jp93g8qWpyjkf\nAAWfMVs/KwfVDclId0YLUDUPa3ulotHlpu0rv98W92YHnhS8Qgvv1bZddwtPfA/6\nhfolWq0QDSEJLHQJovcH/Mv0LcKGpNEVIglmjpmVE3mbClfPjcch2dxxizYUB7pW\nFVFeCnJg6bX4n2XiydCpNJRGwgYztb2FLdQh80wEhPsdH+xW/ll79qEy3Ys3plIO\n1NNQ3uy1eqOfxGAu0WAudJpLbnNXkqIJxieujAdERtfkyzmYPap4h5AJyeBNd1xM\nFNGeU9tu8+O+QJ93tDGYJuyoVvv0gYqXq17aPB5/LDzGbfFYxDiWQxqsUbP57CE=\n=EfzS\n-----END PGP SIGNATURE-----\n",
      "payload": "tree c726d2e658240ea8079e31103d5b7984fe890e6b\nparent 7439136f39c3972bdcda03449b6890c5145db2b7\nauthor Joffrey JAFFEUX <j.jaffeux@gmail.com> 1618918139 +0200\ncommitter GitHub <noreply@github.com> 1618918139 +0200\n\nUX: displays a descriptive error when theme is not allowed (#12763)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3",
  "html_url": "https://github.com/discourse/discourse/commit/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3/comments",
  "author": {
    "login": "jjaffeux",
    "id": 339945,
    "node_id": "MDQ6VXNlcjMzOTk0NQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/339945?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jjaffeux",
    "html_url": "https://github.com/jjaffeux",
    "followers_url": "https://api.github.com/users/jjaffeux/followers",
    "following_url": "https://api.github.com/users/jjaffeux/following{/other_user}",
    "gists_url": "https://api.github.com/users/jjaffeux/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jjaffeux/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jjaffeux/subscriptions",
    "organizations_url": "https://api.github.com/users/jjaffeux/orgs",
    "repos_url": "https://api.github.com/users/jjaffeux/repos",
    "events_url": "https://api.github.com/users/jjaffeux/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jjaffeux/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7439136f39c3972bdcda03449b6890c5145db2b7",
      "url": "https://api.github.com/repos/discourse/discourse/commits/7439136f39c3972bdcda03449b6890c5145db2b7",
      "html_url": "https://github.com/discourse/discourse/commit/7439136f39c3972bdcda03449b6890c5145db2b7"
    }
  ],
  "stats": {
    "total": 18,
    "additions": 12,
    "deletions": 6
  },
  "files": [
    {
      "sha": "eec56598fe5cd321bddc6cce87d8500bf2864c8e",
      "filename": "app/controllers/admin/themes_controller.rb",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "blob_url": "https://github.com/discourse/discourse/blob/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3/app/controllers/admin/themes_controller.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3/app/controllers/admin/themes_controller.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/controllers/admin/themes_controller.rb?ref=69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3",
      "patch": "@@ -92,8 +92,12 @@ def import\n         render json: @theme.errors, status: :unprocessable_entity\n       end\n     elsif remote = params[:remote]\n-\n-      guardian.ensure_allowed_theme_repo_import!(remote.strip)\n+      begin\n+        guardian.ensure_allowed_theme_repo_import!(remote.strip)\n+      rescue Discourse::InvalidAccess\n+        render_json_error I18n.t(\"themes.import_error.not_allowed_theme\", { repo: remote.strip }), status: :forbidden\n+        return\n+      end\n \n       begin\n         branch = params[:branch] ? params[:branch] : nil"
    },
    {
      "sha": "ad261ea81f4a895763d11822b1abd9a193294e7e",
      "filename": "config/locales/server.en.yml",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/discourse/discourse/blob/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3/config/locales/server.en.yml",
      "raw_url": "https://github.com/discourse/discourse/raw/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3/config/locales/server.en.yml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/locales/server.en.yml?ref=69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3",
      "patch": "@@ -78,6 +78,7 @@ en:\n       unpack_failed: \"Failed to unpack file\"\n       file_too_big: \"The uncompressed file is too big.\"\n       unknown_file_type: \"The file you uploaded does not appear to be a valid Discourse theme.\"\n+      not_allowed_theme: \"`%{repo}` is not in the list of allowed themes (check `allowed_theme_repos` global setting).\"\n     errors:\n       component_no_user_selectable: \"Theme components can't be user-selectable\"\n       component_no_default: \"Theme components can't be default theme\""
    },
    {
      "sha": "472bc039814044650fa42c941701d693fd75c14c",
      "filename": "spec/requests/admin/themes_controller_spec.rb",
      "status": "modified",
      "additions": 5,
      "deletions": 4,
      "changes": 9,
      "blob_url": "https://github.com/discourse/discourse/blob/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3/spec/requests/admin/themes_controller_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3/spec/requests/admin/themes_controller_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/requests/admin/themes_controller_spec.rb?ref=69f8c3b3057dbf70ff2b33ab354eea18e7d2d7b3",
      "patch": "@@ -119,13 +119,14 @@\n         expect(response.status).to eq(201)\n       end\n \n-      it \"bans non whtielisted imports\" do\n+      it \"prevents adding disallowed themes\" do\n         RemoteTheme.stubs(:import_theme)\n-        post \"/admin/themes/import.json\", params: {\n-          remote: '    https://bad.com/discourse/discourse-brand-header       '\n-        }\n+        remote = '    https://bad.com/discourse/discourse-brand-header       '\n+\n+        post \"/admin/themes/import.json\", params: { remote: remote }\n \n         expect(response.status).to eq(403)\n+        expect(response.parsed_body['errors']).to include(I18n.t(\"themes.import_error.not_allowed_theme\", { repo: remote.strip }))\n       end\n \n       it \"bans json file import\" do"
    }
  ]
}
