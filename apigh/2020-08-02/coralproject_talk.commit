{
  "sha": "871d3f80c1f00a3b4ad7f9943f06974f3b251d7f",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6ODcxZDNmODBjMWYwMGEzYjRhZDdmOTk0M2YwNjk3NGYzYjI1MWQ3Zg==",
  "commit": {
    "author": {
      "name": "Tessa Thornton",
      "email": "tessathornton@gmail.com",
      "date": "2020-07-31T18:03:54Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-07-31T18:03:54Z"
    },
    "message": "[CORL-1230] corrects logic for editing comments with media attachments (#3063)\n\n* correctly attach media to edited comments\r\n\r\n* ensure media can be removed in edits\r\n\r\n* fix: updates to support repeat post\r\n\r\nCo-authored-by: Kim Gardner <kgardnr@gmail.com>\r\nCo-authored-by: Wyatt Johnson <wyattjoh@gmail.com>",
    "tree": {
      "sha": "50329e6279dead91f3f1e4be1bc038e230fd406c",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/50329e6279dead91f3f1e4be1bc038e230fd406c"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfJF0KCRBK7hj4Ov3rIwAAdHIIAFAgpw6WPXJJLhrAI9VdzI4m\na5rAlE8R+0QBRNto175MJp7IF4jz7bgkIhDszKIhz9zUydFDcsJz1cVP4GJcCqh7\nlBkbLyLlfRXqwQdspXkFEY0z3gkSDNYrYgBXTv6mECOA8+984ZRTvAojCce+fnMQ\nzxdcZOzkLqbn6v86c+W79slqv7nA6rzDhmDbAJ0IQzgM2Qhmn9oYDaF1xi1Nmm/O\nmnrf5VybHrOcHUsMPR7jjpvRk4gWa+0R6sd8VQE6Fx+MzpN9V95jVFQ8cexql6Wl\nq4Xl4BZle9B416A/WuvbBJO2opmdRXBnxJb1YblcBFNp9lNL4NYVK1syHYNyNy4=\n=bxLi\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 50329e6279dead91f3f1e4be1bc038e230fd406c\nparent f7d01174d76f5dcff9d750318b3e9d26af80d9b2\nauthor Tessa Thornton <tessathornton@gmail.com> 1596218634 -0400\ncommitter GitHub <noreply@github.com> 1596218634 +0000\n\n[CORL-1230] corrects logic for editing comments with media attachments (#3063)\n\n* correctly attach media to edited comments\r\n\r\n* ensure media can be removed in edits\r\n\r\n* fix: updates to support repeat post\r\n\r\nCo-authored-by: Kim Gardner <kgardnr@gmail.com>\r\nCo-authored-by: Wyatt Johnson <wyattjoh@gmail.com>"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f",
  "html_url": "https://github.com/coralproject/talk/commit/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f/comments",
  "author": {
    "login": "tessalt",
    "id": 1789029,
    "node_id": "MDQ6VXNlcjE3ODkwMjk=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/1789029?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tessalt",
    "html_url": "https://github.com/tessalt",
    "followers_url": "https://api.github.com/users/tessalt/followers",
    "following_url": "https://api.github.com/users/tessalt/following{/other_user}",
    "gists_url": "https://api.github.com/users/tessalt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tessalt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tessalt/subscriptions",
    "organizations_url": "https://api.github.com/users/tessalt/orgs",
    "repos_url": "https://api.github.com/users/tessalt/repos",
    "events_url": "https://api.github.com/users/tessalt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tessalt/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "f7d01174d76f5dcff9d750318b3e9d26af80d9b2",
      "url": "https://api.github.com/repos/coralproject/talk/commits/f7d01174d76f5dcff9d750318b3e9d26af80d9b2",
      "html_url": "https://github.com/coralproject/talk/commit/f7d01174d76f5dcff9d750318b3e9d26af80d9b2"
    }
  ],
  "stats": {
    "total": 32,
    "additions": 29,
    "deletions": 3
  },
  "files": [
    {
      "sha": "82687c186a42883f0620f8f58db1e6b8a5eb11e1",
      "filename": "src/core/server/services/comments/pipeline/phases/repeatPost.ts",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f/src/core/server/services/comments/pipeline/phases/repeatPost.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f/src/core/server/services/comments/pipeline/phases/repeatPost.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/pipeline/phases/repeatPost.ts?ref=871d3f80c1f00a3b4ad7f9943f06974f3b251d7f",
      "patch": "@@ -16,6 +16,8 @@ import {\n \n export const repeatPost: IntermediateModerationPhase = async ({\n   mongo,\n+  comment,\n+  action,\n   bodyText,\n   tenant,\n   author,\n@@ -44,6 +46,12 @@ export const repeatPost: IntermediateModerationPhase = async ({\n       return;\n     }\n \n+    if (action === \"EDIT\" && comment.id && comment.id === lastComment.id) {\n+      // The last comment written is this comment because we're editing, so no\n+      // need to compare against.\n+      return;\n+    }\n+\n     const lastCommentRevision = getLatestRevision(lastComment);\n     const lastCommentBodyText = getHTMLPlainText(lastCommentRevision.body);\n "
    },
    {
      "sha": "76f82752aedcd0ea27d632b546b634357540e46a",
      "filename": "src/core/server/services/comments/pipeline/pipeline.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f/src/core/server/services/comments/pipeline/pipeline.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f/src/core/server/services/comments/pipeline/pipeline.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/pipeline/pipeline.ts?ref=871d3f80c1f00a3b4ad7f9943f06974f3b251d7f",
      "patch": "@@ -68,7 +68,12 @@ export interface ModerationPhaseContextInput {\n   comment: RequireProperty<\n     Partial<Omit<CreateCommentInput, \"media\">>,\n     \"body\" | \"ancestorIDs\"\n-  >;\n+  > & {\n+    /**\n+     * id is used to provide the comment ID in the event this is a EDIT action.\n+     */\n+    id?: string;\n+  };\n   author: User;\n   now: Date;\n   action: \"NEW\" | \"EDIT\";"
    },
    {
      "sha": "6f5a662eab4506a6900aef6892f5428fbc77334c",
      "filename": "src/core/server/stacks/editComment.ts",
      "status": "modified",
      "additions": 15,
      "deletions": 2,
      "changes": 17,
      "blob_url": "https://github.com/coralproject/talk/blob/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f/src/core/server/stacks/editComment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/871d3f80c1f00a3b4ad7f9943f06974f3b251d7f/src/core/server/stacks/editComment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/editComment.ts?ref=871d3f80c1f00a3b4ad7f9943f06974f3b251d7f",
      "patch": "@@ -14,6 +14,7 @@ import { createCommentModerationAction } from \"coral-server/models/action/modera\n import {\n   editComment,\n   EditCommentInput,\n+  getLatestRevision,\n   GiphyMedia,\n   retrieveComment,\n   TwitterMedia,\n@@ -110,10 +111,22 @@ export default async function edit(\n     throw new StoryNotFoundError(originalStaleComment.storyID);\n   }\n \n+  const lastRevision = getLatestRevision(originalStaleComment);\n+\n   let media: GiphyMedia | TwitterMedia | YouTubeMedia | undefined;\n+\n+  // attach a new media object from input IF:\n+  //   input.media is defined AND EITHER:\n+  //      - previous revision has no media OR\n+  //      - previous revision has media with a different URL\n+  // otherwise, attach previous revision media if present\n+\n   if (input.media) {\n-    // TODO: (wyattjoh) check to see if the media is the same.\n-    media = await attachMedia(tenant, input.media, input.body);\n+    if (!lastRevision.media || lastRevision.media.url !== input.media.url) {\n+      media = await attachMedia(tenant, input.media, input.body);\n+    } else if (lastRevision.media) {\n+      media = lastRevision.media;\n+    }\n   }\n \n   // Run the comment through the moderation phases."
    }
  ]
}
