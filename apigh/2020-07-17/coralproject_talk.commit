{
  "sha": "5b589bfe2be57bdad76c93b1b89d581b475400df",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6NWI1ODliZmUyYmU1N2JkYWQ3NmM5M2IxYjg5ZDU4MWI0NzU0MDBkZg==",
  "commit": {
    "author": {
      "name": "Wyatt Johnson",
      "email": "wyattjoh@gmail.com",
      "date": "2020-07-16T19:59:51Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-07-16T19:59:51Z"
    },
    "message": "[CORL-1180] Moderation + Editing Improvements (#3020)\n\n* fix: handle moderating edited comments better\n\n* fix: add back deleted audit trail entry\n\nCo-authored-by: kodiakhq[bot] <49736102+kodiakhq[bot]@users.noreply.github.com>",
    "tree": {
      "sha": "f177d31ddffea98070a53697b009fa6459a6d59d",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/f177d31ddffea98070a53697b009fa6459a6d59d"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/5b589bfe2be57bdad76c93b1b89d581b475400df",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfELG3CRBK7hj4Ov3rIwAAdHIIABTJSptLNwVl2DXYhBJBNZJq\n1I6QFX/5BR+fWRqLsr37Q5GQGHHfpFtVJ+7DhdcFxBiUGi30QMzgdM5JSz6DZ4iP\nhWvh3nDtXv7J4szVFK8JQB/vuJXyw6CXoBp87gZSSRyskJcsXsoOvninHeytVjmH\n7XBw2PO0mhh947RAVTqdxx7VmZaZK+CLCM6l67+Q/ta4cTUFcGv1cZGGyG+DQEHQ\nFXXIwojBLUn4/FG6ui2s1nwjKiG1r7ceg4ITBoUy/q7wE00xqNTsc/sezWRYenJv\nQNY3d7wnAA+T/S56s6DfKiGiq2mf0x3jZznQwYhW4pOgs5OKGqqgJrNj47RgGgc=\n=ueWF\n-----END PGP SIGNATURE-----\n",
      "payload": "tree f177d31ddffea98070a53697b009fa6459a6d59d\nparent 4f5c0e285c909081a88a7ebf7386b65d9707e356\nauthor Wyatt Johnson <wyattjoh@gmail.com> 1594929591 +0000\ncommitter GitHub <noreply@github.com> 1594929591 +0000\n\n[CORL-1180] Moderation + Editing Improvements (#3020)\n\n* fix: handle moderating edited comments better\n\n* fix: add back deleted audit trail entry\n\nCo-authored-by: kodiakhq[bot] <49736102+kodiakhq[bot]@users.noreply.github.com>"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/5b589bfe2be57bdad76c93b1b89d581b475400df",
  "html_url": "https://github.com/coralproject/talk/commit/5b589bfe2be57bdad76c93b1b89d581b475400df",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/5b589bfe2be57bdad76c93b1b89d581b475400df/comments",
  "author": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4f5c0e285c909081a88a7ebf7386b65d9707e356",
      "url": "https://api.github.com/repos/coralproject/talk/commits/4f5c0e285c909081a88a7ebf7386b65d9707e356",
      "html_url": "https://github.com/coralproject/talk/commit/4f5c0e285c909081a88a7ebf7386b65d9707e356"
    }
  ],
  "stats": {
    "total": 119,
    "additions": 98,
    "deletions": 21
  },
  "files": [
    {
      "sha": "7735873994dc03eb0b037b54d6195c176ac6f638",
      "filename": "src/core/client/admin/mutations/ApproveCommentMutation.ts",
      "status": "modified",
      "additions": 17,
      "deletions": 2,
      "changes": 19,
      "blob_url": "https://github.com/coralproject/talk/blob/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/mutations/ApproveCommentMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/mutations/ApproveCommentMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/mutations/ApproveCommentMutation.ts?ref=5b589bfe2be57bdad76c93b1b89d581b475400df",
      "patch": "@@ -47,7 +47,7 @@ const ApproveCommentMutation = createMutation(\n                   }\n                 }\n               }\n-              ...ModeratedByContainer_comment\n+              ...ModerateCardContainer_comment\n             }\n             moderationQueues(\n               storyID: $storyID\n@@ -83,7 +83,22 @@ const ApproveCommentMutation = createMutation(\n         proxy.setValue(\"APPROVED\", \"status\");\n         proxy.setValue(true, \"viewerDidModerate\");\n       },\n-      updater: (store) => {\n+      updater: (store, data) => {\n+        // If no comment came back or the returned comment status was the same,\n+        // don't remove it from the connections!\n+        if (\n+          !data.approveComment ||\n+          !data.approveComment.comment ||\n+          data.approveComment.comment.status !== \"APPROVED\"\n+        ) {\n+          return;\n+        }\n+\n+        // Ensure that the comment retains the viewerDidModerate state after it\n+        // comes back from the update.\n+        const proxy = store.get(input.commentID)!;\n+        proxy.setValue(true, \"viewerDidModerate\");\n+\n         const connections = [\n           getQueueConnection(\n             store,"
    },
    {
      "sha": "cf74b1dbb25b6505600b3a09a2511e22092e0ee3",
      "filename": "src/core/client/admin/mutations/RejectCommentMutation.ts",
      "status": "modified",
      "additions": 17,
      "deletions": 2,
      "changes": 19,
      "blob_url": "https://github.com/coralproject/talk/blob/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/mutations/RejectCommentMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/mutations/RejectCommentMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/mutations/RejectCommentMutation.ts?ref=5b589bfe2be57bdad76c93b1b89d581b475400df",
      "patch": "@@ -47,7 +47,7 @@ const RejectCommentMutation = createMutation(\n                   }\n                 }\n               }\n-              ...ModeratedByContainer_comment\n+              ...ModerateCardContainer_comment\n             }\n             moderationQueues(\n               storyID: $storyID\n@@ -83,7 +83,22 @@ const RejectCommentMutation = createMutation(\n         proxy.setValue(\"REJECTED\", \"status\");\n         proxy.setValue(true, \"viewerDidModerate\");\n       },\n-      updater: (store) => {\n+      updater: (store, data) => {\n+        // If no comment came back or the returned comment status was the same,\n+        // don't remove it from the connections!\n+        if (\n+          !data.rejectComment ||\n+          !data.rejectComment.comment ||\n+          data.rejectComment.comment.status !== \"REJECTED\"\n+        ) {\n+          return;\n+        }\n+\n+        // Ensure that the comment retains the viewerDidModerate state after it\n+        // comes back from the update.\n+        const proxy = store.get(input.commentID)!;\n+        proxy.setValue(true, \"viewerDidModerate\");\n+\n         const connections = [\n           getQueueConnection(store, \"REPORTED\", input.storyID),\n           getQueueConnection(store, \"PENDING\", input.storyID),"
    },
    {
      "sha": "10ff6ca42ab3ce1c3cd3b036673cf054219fc7e6",
      "filename": "src/core/client/admin/test/moderate/regularQueue.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/test/moderate/regularQueue.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/test/moderate/regularQueue.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/regularQueue.spec.tsx?ref=5b589bfe2be57bdad76c93b1b89d581b475400df",
      "patch": "@@ -375,7 +375,7 @@ it(\"approves comment in reported queue\", async () => {\n       });\n       return {\n         comment: {\n-          id: reportedComments[0].id,\n+          ...reportedComments[0],\n           status: GQLCOMMENT_STATUS.APPROVED,\n           statusHistory: {\n             edges: [\n@@ -473,7 +473,7 @@ it(\"rejects comment in reported queue\", async () => {\n       });\n       return {\n         comment: {\n-          id: reportedComments[0].id,\n+          ...reportedComments[0],\n           status: GQLCOMMENT_STATUS.REJECTED,\n           statusHistory: {\n             edges: ["
    },
    {
      "sha": "b5d9ce14567a0543f90bbdabcac58d88a09495b2",
      "filename": "src/core/client/admin/test/moderate/rejectedQueue.spec.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/test/moderate/rejectedQueue.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/test/moderate/rejectedQueue.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/rejectedQueue.spec.tsx?ref=5b589bfe2be57bdad76c93b1b89d581b475400df",
      "patch": "@@ -245,7 +245,7 @@ it(\"approves comment in rejected queue\", async () => {\n     });\n     return {\n       comment: {\n-        id: rejectedComments[0].id,\n+        ...rejectedComments[0],\n         status: GQLCOMMENT_STATUS.APPROVED,\n         statusHistory: {\n           edges: ["
    },
    {
      "sha": "76d20a4abe9f926e9849f9330117defb84ca8cce",
      "filename": "src/core/client/admin/test/moderate/singleComment.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 3,
      "changes": 5,
      "blob_url": "https://github.com/coralproject/talk/blob/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/test/moderate/singleComment.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/client/admin/test/moderate/singleComment.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/singleComment.spec.tsx?ref=5b589bfe2be57bdad76c93b1b89d581b475400df",
      "patch": "@@ -95,7 +95,7 @@ it(\"approves single comment\", async () => {\n     });\n     return {\n       comment: {\n-        id: comment.id,\n+        ...comment,\n         status: GQLCOMMENT_STATUS.APPROVED,\n         statusHistory: {\n           edges: [\n@@ -148,9 +148,8 @@ it(\"rejects single comment\", async () => {\n     });\n     return {\n       comment: {\n-        id: comment.id,\n+        ...comment,\n         status: GQLCOMMENT_STATUS.REJECTED,\n-        author: comment.author,\n         statusHistory: {\n           edges: [\n             {"
    },
    {
      "sha": "0bb08c859ee23f30f878ed00086aac89b73d1812",
      "filename": "src/core/server/models/comment/helpers.ts",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/server/models/comment/helpers.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/server/models/comment/helpers.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/helpers.ts?ref=5b589bfe2be57bdad76c93b1b89d581b475400df",
      "patch": "@@ -47,6 +47,13 @@ export function getLatestRevision(\n   return comment.revisions[comment.revisions.length - 1];\n }\n \n+export function hasRevision(\n+  comment: Pick<Comment, \"revisions\">,\n+  revisionID: string\n+): boolean {\n+  return comment.revisions.some((revision) => revision.id === revisionID);\n+}\n+\n export function calculateRejectionRate(counts: CommentStatusCounts): number {\n   const published = calculateTotalPublishedCommentCount(counts);\n   const rejected = counts[GQLCOMMENT_STATUS.REJECTED];"
    },
    {
      "sha": "24836299419fcb6cb1ddf865bf1fef345079347f",
      "filename": "src/core/server/services/comments/moderation/moderate.ts",
      "status": "modified",
      "additions": 42,
      "deletions": 11,
      "changes": 53,
      "blob_url": "https://github.com/coralproject/talk/blob/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/server/services/comments/moderation/moderate.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/server/services/comments/moderation/moderate.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/moderation/moderate.ts?ref=5b589bfe2be57bdad76c93b1b89d581b475400df",
      "patch": "@@ -5,7 +5,12 @@ import {\n   createCommentModerationAction,\n   CreateCommentModerationActionInput,\n } from \"coral-server/models/action/moderation/comment\";\n-import { updateCommentStatus } from \"coral-server/models/comment\";\n+import {\n+  getLatestRevision,\n+  hasRevision,\n+  retrieveComment,\n+  updateCommentStatus,\n+} from \"coral-server/models/comment\";\n import { Tenant } from \"coral-server/models/tenant\";\n \n export type Moderate = CreateCommentModerationActionInput;\n@@ -18,18 +23,32 @@ export default async function moderate(\n ) {\n   // TODO: wrap these operations in a transaction?\n \n-  // Create the moderation action in the audit log.\n-  const action = await createCommentModerationAction(\n-    mongo,\n-    tenant.id,\n-    input,\n-    now\n-  );\n-  if (!action) {\n-    // TODO: wrap in better error?\n-    throw new Error(\"could not create moderation action\");\n+  // Get the comment that we're moderating.\n+  const comment = await retrieveComment(mongo, tenant.id, input.commentID);\n+  if (!comment) {\n+    throw new CommentNotFoundError(input.commentID, input.commentRevisionID);\n   }\n \n+  // Get the latest revision on that comment.\n+  const revision = getLatestRevision(comment);\n+\n+  // Ensure that the latest revision is the same revision that we're moderating.\n+  if (revision.id !== input.commentRevisionID) {\n+    // The revision has been updated since then! Ensure that this revision ID\n+    // does exist.\n+    if (!hasRevision(comment, input.commentRevisionID)) {\n+      throw new CommentNotFoundError(input.commentID, input.commentRevisionID);\n+    }\n+\n+    // The comment has this revision, it just isn't the latest one. Return the\n+    // same comment back because we didn't modify anything.\n+    return { before: comment, after: null };\n+  }\n+\n+  // TODO: (wyattjoh) this is a pretty race condition prone check here, replace\n+  // with a more concrete query that can prevent the comment being edited in the\n+  // time it takes to go from the above block to the next block.\n+\n   // Update the Comment's status.\n   const result = await updateCommentStatus(\n     mongo,\n@@ -42,5 +61,17 @@ export default async function moderate(\n     throw new CommentNotFoundError(input.commentID, input.commentRevisionID);\n   }\n \n+  // Create the moderation action in the audit log.\n+  const action = await createCommentModerationAction(\n+    mongo,\n+    tenant.id,\n+    input,\n+    now\n+  );\n+  if (!action) {\n+    // TODO: wrap in better error?\n+    throw new Error(\"could not create moderation action\");\n+  }\n+\n   return result;\n }"
    },
    {
      "sha": "fa1174cff00c56c5d2bb42a2e4b474e0c1cd2eac",
      "filename": "src/core/server/stacks/approveComment.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/coralproject/talk/blob/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/server/stacks/approveComment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/server/stacks/approveComment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/approveComment.ts?ref=5b589bfe2be57bdad76c93b1b89d581b475400df",
      "patch": "@@ -32,6 +32,11 @@ const approveComment = async (\n     now\n   );\n \n+  // If the comment hasn't been updated, skip the rest of the steps.\n+  if (!result.after) {\n+    return result.before;\n+  }\n+\n   // Update all the comment counts on stories and users.\n   const counts = await updateAllCommentCounts(mongo, redis, {\n     ...result,"
    },
    {
      "sha": "5487545ae3482672d598704987ae3f0eb10f3ed0",
      "filename": "src/core/server/stacks/rejectComment.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/coralproject/talk/blob/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/server/stacks/rejectComment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/5b589bfe2be57bdad76c93b1b89d581b475400df/src/core/server/stacks/rejectComment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/rejectComment.ts?ref=5b589bfe2be57bdad76c93b1b89d581b475400df",
      "patch": "@@ -37,6 +37,11 @@ const rejectComment = async (\n     now\n   );\n \n+  // If the comment hasn't been updated, skip the rest of the steps.\n+  if (!result.after) {\n+    return result.before;\n+  }\n+\n   // Update all the comment counts on stories and users.\n   const counts = await updateAllCommentCounts(mongo, redis, {\n     ...result,"
    }
  ]
}
