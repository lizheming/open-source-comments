{
  "sha": "4b793a1072f4fcb37b916dcb309dec720a8f099b",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo0Yjc5M2ExMDcyZjRmY2IzN2I5MTZkY2IzMDlkZWM3MjBhOGYwOTli",
  "commit": {
    "author": {
      "name": "Joffrey JAFFEUX",
      "email": "j.jaffeux@gmail.com",
      "date": "2020-06-12T10:54:28Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-06-12T10:54:28Z"
    },
    "message": "FIX: allows PM owner to remove any user if >= TL2 (#10036)",
    "tree": {
      "sha": "4a22bc3b8864c9c4c30d42bcbc1a6c883105c480",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/4a22bc3b8864c9c4c30d42bcbc1a6c883105c480"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/4b793a1072f4fcb37b916dcb309dec720a8f099b",
    "comment_count": 1,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe417kCRBK7hj4Ov3rIwAAdHIIABci4eKJs1yQdpRJsjZjsoCd\nkBFlLZbcaBVv5A4+jAg8A4lvgwq1O9NFb8+65HzuiSHvG9rwJCVwg9D2IaNUsVP5\nf3LxRCSmIdwhhJvjTVWNswa/x3HeNyMUXirRljySigGUhm5wdO4t1vtNZ8ZC1VnY\nZ5YHlUdHAc1o0sZ+3bgl4sWu+1UxG+bCFN80F/go2TJUcy95vhhJ9zBj2jcA+iti\n5ZpNCkONwtEDR76EQUr2quBfiQGXAiNGcQ2/oZg3JbXFXKFxb2W2R/7c+GO40aP0\nyrNstZ9hMh1lEkMenUOtnYWoWICiVuINJw8wQxiWhtHRg29HWmHEGzH3F7xk+5Q=\n=y6PK\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 4a22bc3b8864c9c4c30d42bcbc1a6c883105c480\nparent 7211394e4da89e94506e42a79bf7cc361ba99bd9\nauthor Joffrey JAFFEUX <j.jaffeux@gmail.com> 1591959268 +0200\ncommitter GitHub <noreply@github.com> 1591959268 +0200\n\nFIX: allows PM owner to remove any user if >= TL2 (#10036)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/4b793a1072f4fcb37b916dcb309dec720a8f099b",
  "html_url": "https://github.com/discourse/discourse/commit/4b793a1072f4fcb37b916dcb309dec720a8f099b",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/4b793a1072f4fcb37b916dcb309dec720a8f099b/comments",
  "author": {
    "login": "jjaffeux",
    "id": 339945,
    "node_id": "MDQ6VXNlcjMzOTk0NQ==",
    "avatar_url": "https://avatars3.githubusercontent.com/u/339945?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jjaffeux",
    "html_url": "https://github.com/jjaffeux",
    "followers_url": "https://api.github.com/users/jjaffeux/followers",
    "following_url": "https://api.github.com/users/jjaffeux/following{/other_user}",
    "gists_url": "https://api.github.com/users/jjaffeux/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jjaffeux/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jjaffeux/subscriptions",
    "organizations_url": "https://api.github.com/users/jjaffeux/orgs",
    "repos_url": "https://api.github.com/users/jjaffeux/repos",
    "events_url": "https://api.github.com/users/jjaffeux/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jjaffeux/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7211394e4da89e94506e42a79bf7cc361ba99bd9",
      "url": "https://api.github.com/repos/discourse/discourse/commits/7211394e4da89e94506e42a79bf7cc361ba99bd9",
      "html_url": "https://github.com/discourse/discourse/commit/7211394e4da89e94506e42a79bf7cc361ba99bd9"
    }
  ],
  "stats": {
    "total": 18,
    "additions": 17,
    "deletions": 1
  },
  "files": [
    {
      "sha": "33f5d836f4ae9e564d2374bf000f25db0e25d7b2",
      "filename": "lib/guardian/topic_guardian.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/discourse/discourse/blob/4b793a1072f4fcb37b916dcb309dec720a8f099b/lib/guardian/topic_guardian.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/4b793a1072f4fcb37b916dcb309dec720a8f099b/lib/guardian/topic_guardian.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/guardian/topic_guardian.rb?ref=4b793a1072f4fcb37b916dcb309dec720a8f099b",
      "patch": "@@ -5,6 +5,7 @@ module TopicGuardian\n \n   def can_remove_allowed_users?(topic, target_user = nil)\n     is_staff? ||\n+    (topic.user == user && user.has_trust_level?(TrustLevel[2])) ||\n     (\n       topic.allowed_users.count > 1 &&\n       topic.user != target_user &&"
    },
    {
      "sha": "ef8245254de1ea382b09357922910aa9ed38dac4",
      "filename": "spec/components/guardian_spec.rb",
      "status": "modified",
      "additions": 16,
      "deletions": 1,
      "changes": 17,
      "blob_url": "https://github.com/discourse/discourse/blob/4b793a1072f4fcb37b916dcb309dec720a8f099b/spec/components/guardian_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/4b793a1072f4fcb37b916dcb309dec720a8f099b/spec/components/guardian_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/components/guardian_spec.rb?ref=4b793a1072f4fcb37b916dcb309dec720a8f099b",
      "patch": "@@ -3446,8 +3446,23 @@\n       end\n     end\n \n+    context 'trust_level >= 2 user' do\n+      fab!(:topic_creator) { build(:user, trust_level: 2) }\n+      fab!(:topic) { Fabricate(:topic, user: topic_creator) }\n+\n+      before do\n+        topic.allowed_users << topic_creator\n+        topic.allowed_users << another_user\n+      end\n+\n+      it 'should be true' do\n+        expect(Guardian.new(topic_creator).can_remove_allowed_users?(topic))\n+          .to eq(true)\n+      end\n+    end\n+\n     context 'normal user' do\n-      fab!(:topic) { Fabricate(:topic, user: Fabricate(:user)) }\n+      fab!(:topic) { Fabricate(:topic, user: Fabricate(:user, trust_level: 1)) }\n \n       before do\n         topic.allowed_users << user"
    }
  ]
}
