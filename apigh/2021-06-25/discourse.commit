{
  "sha": "b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODpiNGYwYTBmYjk0ODkyMjNmNmQ0ZDU2ZGRiZmUwZjU1MzJhNmY1OThh",
  "commit": {
    "author": {
      "name": "Jarek Radosz",
      "email": "jradosz@gmail.com",
      "date": "2021-06-25T09:34:51Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2021-06-25T09:34:51Z"
    },
    "message": "FIX: Nil-filled CF arrays were not being deleted (#13518)",
    "tree": {
      "sha": "cec08ff364ba8cd49ae57e5efe212b7c7d7035b1",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/cec08ff364ba8cd49ae57e5efe212b7c7d7035b1"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg1aM7CRBK7hj4Ov3rIwAA69YIALMJjPwoYm4GBV8Vgtyr5/ig\nlZmq7JUFveaSalrk7RQ0E7qsz3gcA0Aifuknj4zXwTPqELWnXGTv7PInyb7FBrLC\nTZEJrlDTuYUNGKNeTd/yj9TaxQi970Y0KpcFSCScplmvXmYBNhfqmK5EMiM48Plv\nh6tbFkoYPpXqacPbAyPAJrDaFDegTtTc05DgKM08W/A5McaITMIyiY6P//hAJx1U\nPFify138HrfqF9nbuzqXu4ipP08BmSVvniS2ZkcAMgl8z1KUHPUllIFBvIL44j6k\nHU0ulKVnN0hdrFWLBGyb8EbwgLNTEPI+Yn469JDJoLvYslimUXsOe2Bxc64TKJ0=\n=8PXW\n-----END PGP SIGNATURE-----\n",
      "payload": "tree cec08ff364ba8cd49ae57e5efe212b7c7d7035b1\nparent 8ab6fd88ef231ed782c9ce85c4424f81ec5a50a2\nauthor Jarek Radosz <jradosz@gmail.com> 1624613691 +0200\ncommitter GitHub <noreply@github.com> 1624613691 +0200\n\nFIX: Nil-filled CF arrays were not being deleted (#13518)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a",
  "html_url": "https://github.com/discourse/discourse/commit/b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a/comments",
  "author": {
    "login": "CvX",
    "id": 66961,
    "node_id": "MDQ6VXNlcjY2OTYx",
    "avatar_url": "https://avatars.githubusercontent.com/u/66961?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/CvX",
    "html_url": "https://github.com/CvX",
    "followers_url": "https://api.github.com/users/CvX/followers",
    "following_url": "https://api.github.com/users/CvX/following{/other_user}",
    "gists_url": "https://api.github.com/users/CvX/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/CvX/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/CvX/subscriptions",
    "organizations_url": "https://api.github.com/users/CvX/orgs",
    "repos_url": "https://api.github.com/users/CvX/repos",
    "events_url": "https://api.github.com/users/CvX/events{/privacy}",
    "received_events_url": "https://api.github.com/users/CvX/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "8ab6fd88ef231ed782c9ce85c4424f81ec5a50a2",
      "url": "https://api.github.com/repos/discourse/discourse/commits/8ab6fd88ef231ed782c9ce85c4424f81ec5a50a2",
      "html_url": "https://github.com/discourse/discourse/commit/8ab6fd88ef231ed782c9ce85c4424f81ec5a50a2"
    }
  ],
  "stats": {
    "total": 21,
    "additions": 16,
    "deletions": 5
  },
  "files": [
    {
      "sha": "f073544dbb1a10aad7bfb9bdfa2ae99b928b6df5",
      "filename": "app/models/concerns/has_custom_fields.rb",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/discourse/discourse/blob/b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a/app/models/concerns/has_custom_fields.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a/app/models/concerns/has_custom_fields.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/concerns/has_custom_fields.rb?ref=b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a",
      "patch": "@@ -233,10 +233,10 @@ def save_custom_fields(force = false)\n             t = {}\n             self.class.append_custom_field(t, f.name, f.value)\n \n-            if dup[f.name] != t[f.name]\n-              f.destroy!\n-            else\n+            if dup.has_key?(f.name) && dup[f.name] == t[f.name]\n               dup.delete(f.name)\n+            else\n+              f.destroy!\n             end\n           end\n         end"
    },
    {
      "sha": "c2f4aff3172ff141f81153eec6b590f1589602e7",
      "filename": "spec/components/concern/has_custom_fields_spec.rb",
      "status": "modified",
      "additions": 13,
      "deletions": 2,
      "changes": 15,
      "blob_url": "https://github.com/discourse/discourse/blob/b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a/spec/components/concern/has_custom_fields_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a/spec/components/concern/has_custom_fields_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/components/concern/has_custom_fields_spec.rb?ref=b4f0a0fb9489223f6d4d56ddbfe0f5532a6f598a",
      "patch": "@@ -3,7 +3,6 @@\n require \"rails_helper\"\n \n describe HasCustomFields do\n-\n   context \"custom_fields\" do\n     before do\n       DB.exec(\"create temporary table custom_fields_test_items(id SERIAL primary key)\")\n@@ -104,7 +103,6 @@ class CustomFieldsTestItemCustomField < ActiveRecord::Base\n     end\n \n     it \"handles arrays properly\" do\n-\n       CustomFieldsTestItem.register_custom_field_type \"array\", [:integer]\n       test_item = CustomFieldsTestItem.new\n       test_item.custom_fields = { \"array\" => [\"1\"] }\n@@ -136,6 +134,19 @@ class CustomFieldsTestItemCustomField < ActiveRecord::Base\n       expect(db_item.custom_fields).to eq({})\n     end\n \n+    it \"deletes nil-filled arrays\" do\n+      test_item = CustomFieldsTestItem.create!\n+      db_item = CustomFieldsTestItem.find(test_item.id)\n+\n+      db_item.custom_fields.update(\"a\" => [nil, nil])\n+      db_item.save_custom_fields\n+      db_item.custom_fields.delete(\"a\")\n+      expect(db_item.custom_fields).to eq({})\n+\n+      db_item.save_custom_fields\n+      expect(db_item.custom_fields).to eq({})\n+    end\n+\n     it \"casts integers in arrays properly without error\" do\n       test_item = CustomFieldsTestItem.new\n       test_item.custom_fields = { \"a\" => [\"b\", 10, \"d\"] }"
    }
  ]
}
